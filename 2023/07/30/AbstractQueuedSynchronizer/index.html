<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/limxtop/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/limxtop/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2276020567327330" crossorigin="anonymous"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-QHV8ETBTFQ"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-QHV8ETBTFQ")</script><link rel="alternate" type="application/rss+xml" title="若批评不自由，则赞美无意义" href="https://limxtop1989.github.io/limxtop/rss.xml"><link rel="alternate" type="application/atom+xml" title="若批评不自由，则赞美无意义" href="https://limxtop1989.github.io/limxtop/atom.xml"><link rel="alternate" type="application/json" title="若批评不自由，则赞美无意义" href="https://limxtop1989.github.io/limxtop/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/limxtop/css/app.css?v=0.2.5"><link rel="canonical" href="https://limxtop1989.github.io/limxtop/2023/07/30/AbstractQueuedSynchronizer/"><title>Java 并发框架 AbstractQueuedSynchronizer - Java | Yume Shoka = 若批评不自由，则赞美无意义 = 有梦书架</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Java 并发框架 AbstractQueuedSynchronizer</h1><div class="meta"><span class="item" title="Created: 2023-07-30 08:58:02"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2023-07-30T08:58:02+08:00">2023-07-30</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>11k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>10 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/limxtop/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?118986"></li><li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?841358"></li><li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?466483"></li><li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?870712"></li><li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?803855"></li><li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?70412"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/limxtop/">Home</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/limxtop/categories/Java/" itemprop="item" rel="index" title="In Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://limxtop1989.github.io/limxtop/2023/07/30/AbstractQueuedSynchronizer/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/limxtop/images/avatar.jpg"><meta itemprop="name" content="文理兼修电脑首席"><meta itemprop="description" content="有梦书架, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="若批评不自由，则赞美无意义"></span><div class="body md" itemprop="articleBody"><p><img data-src="https://s3.uuu.ovh/imgs/2023/07/30/84de061a940ab561.png" alt=""><br>关于 AbstractQueuedSynchronizer 的源码分析，我以 ReentrantLock 为例，类图如上。</p><blockquote><p>A reentrant mutual exclusion Lock with the same basic behavior and semantics as the implicit monitor lock accessed using synchronized methods and statements, but with extended capabilities.</p></blockquote><blockquote><p>A ReentrantLock is owned by the thread last successfully locking, but not yet unlocking it. A thread invoking lock will return, successfully acquiring the lock, when the lock is not owned by another thread. The method will return immediately if the current thread already owns the lock. This can be checked using methods isHeldByCurrentThread, and getHoldCount.</p></blockquote><p>Lock 接口定义了关于 Lock 的三个主要操作：</p><ol><li>lock();</li><li>unLock();</li><li>newCondition();</li></ol><p><code>ReentrantLock</code> 实现 <code>Lock</code> 接口，但实现的细节全都委派给内部类 <code>Sync</code> 的具体实例。其中值得注意的是，创建 <code>ReentrantLock</code> 实例时，可以传递 <code>fair</code> 参数，指明实现的是公平锁还是非公平锁，默认为非公平锁。</p><p>总体流程如图<br><img data-src="https://s3.uuu.ovh/imgs/2023/07/30/602b88085d477f84.png" alt=""></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    * Creates an instance of &#123;@code ReentrantLock&#125;.</pre></td></tr><tr><td data-num="3"></td><td><pre>    * This is equivalent to using &#123;@code ReentrantLock(false)&#125;.</pre></td></tr><tr><td data-num="4"></td><td><pre>    */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    * Creates an instance of &#123;@code ReentrantLock&#125; with the</pre></td></tr><tr><td data-num="11"></td><td><pre>    * given fairness policy.</pre></td></tr><tr><td data-num="12"></td><td><pre>    *</pre></td></tr><tr><td data-num="13"></td><td><pre>    * @param fair &#123;@code true&#125; if this lock should use a fair ordering policy</pre></td></tr><tr><td data-num="14"></td><td><pre>    */</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>公平锁指线程 <code>lock</code> 时得按顺序排队，等待队列为空时才抢占锁，否则进入队列排队等待。</p><h1 id="thread-b-加锁失败进入等待"><a class="anchor" href="#thread-b-加锁失败进入等待">#</a> Thread B 加锁失败，进入等待</h1><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.ReentrantLock.FairSync#lock</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#acquire</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    * Acquires in exclusive mode, ignoring interrupts.  Implemented</pre></td></tr><tr><td data-num="3"></td><td><pre>    * by invoking at least once &#123;@link #tryAcquire&#125;,</pre></td></tr><tr><td data-num="4"></td><td><pre>    * returning on success.  Otherwise the thread is queued, possibly</pre></td></tr><tr><td data-num="5"></td><td><pre>    * repeatedly blocking and unblocking, invoking &#123;@link</pre></td></tr><tr><td data-num="6"></td><td><pre>    * #tryAcquire&#125; until success.  This method can be used</pre></td></tr><tr><td data-num="7"></td><td><pre>    * to implement method &#123;@link Lock#lock&#125;.</pre></td></tr><tr><td data-num="8"></td><td><pre>    *</pre></td></tr><tr><td data-num="9"></td><td><pre>    * @param arg the acquire argument.  This value is conveyed to</pre></td></tr><tr><td data-num="10"></td><td><pre>    *        &#123;@link #tryAcquire&#125; but is otherwise uninterpreted and</pre></td></tr><tr><td data-num="11"></td><td><pre>    *        can represent anything you like.</pre></td></tr><tr><td data-num="12"></td><td><pre>    */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>先 <code>tryAcquire</code> 尝试获得锁，尝试失败，则 <code>acquireQueued</code> 。在 AbstractQueuedSynchronizer <code>tryAcquire</code> 是模版方法，强制子类实现</p><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.ReentrantLock.FairSync#tryAcquire</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    * Fair version of tryAcquire.  Don't grant access unless</pre></td></tr><tr><td data-num="3"></td><td><pre>    * recursive call or no waiters or is first.</pre></td></tr><tr><td data-num="4"></td><td><pre>    */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 没有线程持有锁，(线程成功获得锁时，会将 state 递增 acquires)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 已经有线程持有锁，判断该锁拥有者是不是当前线程，是则递增 acquires 直接返回 true 表示成功加锁。</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 线程加锁后，可以继续加锁，是故可重入锁</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 该锁被其他线程持有，返回 false， 加锁失败，执行 acquireQueued 进入等待队列。</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol><li>获得锁的逻辑很清晰简单，获取状态，当 state == 0 时，意味着没有线程持有该锁，再判断队列没有前驱并且用 CAS 操作更新 state，使其大于 0，如果更新操作成功，当前线程获得锁，在 setExclusiveOwnerThread 方法里将 exclusiveOwnerThread 指向当前线程。(compare expectedValue with the state value in the memory, and set the state value only if they are equal, which is atomic operation. 由于 state &amp; exclusiveOwnerThread 是共享变量，此代码块是 critical section (临界区)，所以比较和更新必须是原子操作，防止线程 A 比较更新中间，线程 B 更新 state，导致线程 AB 同时获得锁)</li><li>如果 state &gt; 0, 意味着已经有线程持有该锁，但不必灰心，代码进一步判断当前锁的持有者是否是当前线程，如果是，则累加锁数量。</li><li>我们重点来看加锁失败，加入等待队列的情况。</li></ol><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#addWaiter</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    * Creates and enqueues node for current thread and given mode.</pre></td></tr><tr><td data-num="3"></td><td><pre>    *</pre></td></tr><tr><td data-num="4"></td><td><pre>    * @param mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared</pre></td></tr><tr><td data-num="5"></td><td><pre>    * @return the new node</pre></td></tr><tr><td data-num="6"></td><td><pre>    */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// Try the fast path of enq; backup to full enq on failure</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">return</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>将当前线程和锁模式 <code>exclusive</code> 封装在 <code>Node</code> 里，加入队列末尾。</p><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#acquireQueued</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    * Acquires in exclusive uninterruptible mode for thread already in</pre></td></tr><tr><td data-num="3"></td><td><pre>    * queue. Used by condition wait methods as well as acquire.</pre></td></tr><tr><td data-num="4"></td><td><pre>    *</pre></td></tr><tr><td data-num="5"></td><td><pre>    * @param node the node</pre></td></tr><tr><td data-num="6"></td><td><pre>    * @param arg the acquire argument</pre></td></tr><tr><td data-num="7"></td><td><pre>    * @return &#123;@code true&#125; if interrupted while waiting</pre></td></tr><tr><td data-num="8"></td><td><pre>    */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token comment">// 等待队列有前驱等待节点，才进入此方法，但此时可能前驱节点已经移除，</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 是故这里判断等待队列为空，重新尝试获取锁</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">// 重点在这里</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>先简略理解下 <code>shouldParkAfterFailedAcquire</code> ，如果前驱节点</p><ol><li>是 Signal，则返回 true，执行 parkAndCheckInterrupt。</li><li>是 Cancel，则移除 Cancel 的等待节点.</li><li>将非 Cancel 的前驱节点，状态升级为 Signal，下次循环进来，就是 case 1.</li></ol><p>在这里，我们记住，当前等待线程的前驱节点，到最后是 Signal 状态。</p><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#shouldParkAfterFailedAcquire</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    * Checks and updates status for a node that failed to acquire.</pre></td></tr><tr><td data-num="3"></td><td><pre>    * Returns true if thread should block. This is the main signal</pre></td></tr><tr><td data-num="4"></td><td><pre>    * control in all acquire loops.  Requires that pred == node.prev.</pre></td></tr><tr><td data-num="5"></td><td><pre>    *</pre></td></tr><tr><td data-num="6"></td><td><pre>    * @param pred node's predecessor holding status</pre></td></tr><tr><td data-num="7"></td><td><pre>    * @param node the node</pre></td></tr><tr><td data-num="8"></td><td><pre>    * @return &#123;@code true&#125; if thread should block</pre></td></tr><tr><td data-num="9"></td><td><pre>    */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> pred<span class="token punctuation">,</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            * This node has already set status asking a release</pre></td></tr><tr><td data-num="15"></td><td><pre>            * to signal it, so it can safely park.</pre></td></tr><tr><td data-num="16"></td><td><pre>            */</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            * Predecessor was cancelled. Skip over predecessors and</pre></td></tr><tr><td data-num="21"></td><td><pre>            * indicate retry.</pre></td></tr><tr><td data-num="22"></td><td><pre>            */</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            * waitStatus must be 0 or PROPAGATE.  Indicate that we</pre></td></tr><tr><td data-num="30"></td><td><pre>            * need a signal, but don't park yet.  Caller will need to</pre></td></tr><tr><td data-num="31"></td><td><pre>            * retry to make sure it cannot acquire before parking.</pre></td></tr><tr><td data-num="32"></td><td><pre>            */</pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>接下来，我们看 <code>parkAndCheckInterrupt</code> 则当前线程休眠，开始进入等待态（没什么特别的，就设置一个状态标记，告诉线程调度算法不用拿此线程参与调度计算），并检查中断状态。</p><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#parkAndCheckInterrupt</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    * Convenience method to park and then check if interrupted</pre></td></tr><tr><td data-num="3"></td><td><pre>    *</pre></td></tr><tr><td data-num="4"></td><td><pre>    * @return &#123;@code true&#125; if interrupted</pre></td></tr><tr><td data-num="5"></td><td><pre>    */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这行代码执行完毕，线程进入休眠，等待其他线程调用 unpark 后，执行下一行的 retrun</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.LockSupport#park(java.lang.Object)</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Disables the current thread for thread scheduling purposes unless the</pre></td></tr><tr><td data-num="3"></td><td><pre> * permit is available.</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * &lt;p>If the permit is available then it is consumed and the call returns</pre></td></tr><tr><td data-num="6"></td><td><pre> * immediately; otherwise</pre></td></tr><tr><td data-num="7"></td><td><pre> * the current thread becomes disabled for thread scheduling</pre></td></tr><tr><td data-num="8"></td><td><pre> * purposes and lies dormant until one of three things happens:</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * &lt;ul></pre></td></tr><tr><td data-num="11"></td><td><pre> * &lt;li>Some other thread invokes &#123;@link #unpark unpark&#125; with the</pre></td></tr><tr><td data-num="12"></td><td><pre> * current thread as the target; or</pre></td></tr><tr><td data-num="13"></td><td><pre> *</pre></td></tr><tr><td data-num="14"></td><td><pre> * &lt;li>Some other thread &#123;@linkplain Thread#interrupt interrupts&#125;</pre></td></tr><tr><td data-num="15"></td><td><pre> * the current thread; or</pre></td></tr><tr><td data-num="16"></td><td><pre> *</pre></td></tr><tr><td data-num="17"></td><td><pre> * &lt;li>The call spuriously (that is, for no reason) returns.</pre></td></tr><tr><td data-num="18"></td><td><pre> * &lt;/ul></pre></td></tr><tr><td data-num="19"></td><td><pre> *</pre></td></tr><tr><td data-num="20"></td><td><pre> * &lt;p>This method does &lt;em>not&lt;/em> report which of these caused the</pre></td></tr><tr><td data-num="21"></td><td><pre> * method to return. Callers should re-check the conditions which caused</pre></td></tr><tr><td data-num="22"></td><td><pre> * the thread to park in the first place. Callers may also determine,</pre></td></tr><tr><td data-num="23"></td><td><pre> * for example, the interrupt status of the thread upon return.</pre></td></tr><tr><td data-num="24"></td><td><pre> *</pre></td></tr><tr><td data-num="25"></td><td><pre> * @param blocker the synchronization object responsible for this</pre></td></tr><tr><td data-num="26"></td><td><pre> *        thread parking</pre></td></tr><tr><td data-num="27"></td><td><pre> * @since 1.6</pre></td></tr><tr><td data-num="28"></td><td><pre> */</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token class-name">Object</span> blocker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">setBlocker</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> blocker<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    UNSAFE<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">setBlocker</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>到这里，Thread B 线程加锁失败，进入等待队列，休眠，等待其他线程释放锁，通知唤醒等待队列的线程，重新竞争获得锁。我们开始看其他线程释放锁流程。</p><h1 id="thread-b-释放锁"><a class="anchor" href="#thread-b-释放锁">#</a> Thread B 释放锁</h1><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.ReentrantLock#unlock</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Attempts to release this lock.</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * &lt;p>If the current thread is the holder of this lock then the hold</pre></td></tr><tr><td data-num="5"></td><td><pre> * count is decremented.  If the hold count is now zero then the lock</pre></td></tr><tr><td data-num="6"></td><td><pre> * is released.  If the current thread is not the holder of this</pre></td></tr><tr><td data-num="7"></td><td><pre> * lock then &#123;@link IllegalMonitorStateException&#125; is thrown.</pre></td></tr><tr><td data-num="8"></td><td><pre> *</pre></td></tr><tr><td data-num="9"></td><td><pre> * @throws IllegalMonitorStateException if the current thread does not</pre></td></tr><tr><td data-num="10"></td><td><pre> *         hold this lock</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#release</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Releases in exclusive mode.  Implemented by unblocking one or</pre></td></tr><tr><td data-num="3"></td><td><pre> * more threads if &#123;@link #tryRelease&#125; returns true.</pre></td></tr><tr><td data-num="4"></td><td><pre> * This method can be used to implement method &#123;@link Lock#unlock&#125;.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param arg the release argument.  This value is conveyed to</pre></td></tr><tr><td data-num="7"></td><td><pre> *        &#123;@link #tryRelease&#125; but is otherwise uninterpreted and</pre></td></tr><tr><td data-num="8"></td><td><pre> *        can represent anything you like.</pre></td></tr><tr><td data-num="9"></td><td><pre> * @return the value returned from &#123;@link #tryRelease&#125;</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>尝试释放锁，然后 unpark 锁等待队列的第一个线程，使其进入等待调度状态。</p><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.ReentrantLock.Sync#tryRelease</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> free<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#unparkSuccessor</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>* Wakes up node's successor, if one exists.</pre></td></tr><tr><td data-num="3"></td><td><pre>*</pre></td></tr><tr><td data-num="4"></td><td><pre>* @param node the node</pre></td></tr><tr><td data-num="5"></td><td><pre>*/</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    * If status is negative (i.e., possibly needing signal) try</pre></td></tr><tr><td data-num="9"></td><td><pre>    * to clear in anticipation of signalling.  It is OK if this</pre></td></tr><tr><td data-num="10"></td><td><pre>    * fails or if status is changed by waiting thread.</pre></td></tr><tr><td data-num="11"></td><td><pre>    */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    * Thread to unpark is held in successor, which is normally</pre></td></tr><tr><td data-num="18"></td><td><pre>    * just the next node.  But if cancelled or apparently null,</pre></td></tr><tr><td data-num="19"></td><td><pre>    * traverse backwards from tail to find the actual</pre></td></tr><tr><td data-num="20"></td><td><pre>    * non-cancelled successor.</pre></td></tr><tr><td data-num="21"></td><td><pre>    */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        s <span class="token operator">=</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>传入 h 指向的是哨兵头节点，找到锁等待队列里第一个 <code>waitStatus &lt;= 0</code> 即 SIGNAL CONDITION PROPAGATE 三者之一的节点，并 unpark 唤醒节点里的线程。<br>当上文 Thread B 加锁失败，进入等待锁队列的节点</p><ol><li>是这个头节点，加锁线程被唤醒，thread schedule 分配它运行后，它从 park 中返回，并检测记录 interrupted，进入下一次循环，此时它的前驱就是 head 哨兵节点，再次执行 <code>tryAcquire</code> 流程。</li><li>不是头节点，那么等待前面的节点都纷纷通过 <code>tryAcquire</code> 获得锁，然后释放锁后，文中上一个加锁的线程所在节点最终会成为头节点。</li></ol><p>获得锁成功后，返回 interrupted 中断状态，如果该线程是 interrupted 而进入等待态，则返回后重置还原 interrupted 状态。</p><p>线程从休眠进入等待态有三种 cases 见 <code>java.util.concurrent.locks.LockSupport#park(java.lang.Object)</code> ：</p><ol><li>Some other thread invokes unpark with the current thread as the target; or</li><li>Some other thread interrupts the current thread; or</li><li>The call spuriously (that is, for no reason) returns.</li></ol><figure class="highlight java"><figcaption data-lang="java"><span>a java.util.concurrent.locks.AbstractQueuedSynchronizer#acquireQueued</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Acquires in exclusive uninterruptible mode for thread already in</pre></td></tr><tr><td data-num="3"></td><td><pre> * queue. Used by condition wait methods as well as acquire.</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param node the node</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param arg the acquire argument</pre></td></tr><tr><td data-num="7"></td><td><pre> * @return &#123;@code true&#125; if interrupted while waiting</pre></td></tr><tr><td data-num="8"></td><td><pre> */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2023-07-30 16:54:36" itemprop="dateModified" datetime="2023-07-30T16:54:36+08:00">2023-07-30</time> </span><span id="2023/07/30/AbstractQueuedSynchronizer/" class="item leancloud_visitors" data-flag-title="Java 并发框架 AbstractQueuedSynchronizer" title="Views"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">Views</span> <span class="leancloud-visitors-count"></span> <span class="text">times</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/limxtop/images/wechatpay.png" alt="文理兼修电脑首席 WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/limxtop/images/alipay.png" alt="文理兼修电脑首席 Alipay"><p>Alipay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>文理兼修电脑首席 <i class="ic i-at"><em>@</em></i>若批评不自由，则赞美无意义</li><li class="link"><strong>Post link: </strong><a href="https://limxtop1989.github.io/limxtop/2023/07/30/AbstractQueuedSynchronizer/" title="Java 并发框架 AbstractQueuedSynchronizer">https://limxtop1989.github.io/limxtop/2023/07/30/AbstractQueuedSynchronizer/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/limxtop/2023/07/29/semaphore/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tuapi.eees.cc&#x2F;api.php?category&#x3D;dongman&amp;type&#x3D;302&amp;?260415" title="Semaphore"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>Semaphore</h3></a></div><div class="item right"><a href="/limxtop/2023/07/30/RxJava-Schedule/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tuapi.eees.cc&#x2F;api.php?category&#x3D;dongman&amp;type&#x3D;302&amp;?219760" title="RxJava Schedule"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>RxJava Schedule</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#thread-b-%E5%8A%A0%E9%94%81%E5%A4%B1%E8%B4%A5%E8%BF%9B%E5%85%A5%E7%AD%89%E5%BE%85"><span class="toc-number">1.</span> <span class="toc-text">Thread B 加锁失败，进入等待</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#thread-b-%E9%87%8A%E6%94%BE%E9%94%81"><span class="toc-number">2.</span> <span class="toc-text">Thread B 释放锁</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/limxtop/2022/09/10/Java-IO/" rel="bookmark" title="Java IO">Java IO</a></li><li><a href="/limxtop/2023/07/27/thread-pool/" rel="bookmark" title="线程池">线程池</a></li><li><a href="/limxtop/2023/07/29/CountDownLatch/" rel="bookmark" title="CountDownLatch">CountDownLatch</a></li><li class="active"><a href="/limxtop/2023/07/30/AbstractQueuedSynchronizer/" rel="bookmark" title="Java 并发框架 AbstractQueuedSynchronizer">Java 并发框架 AbstractQueuedSynchronizer</a></li><li><a href="/limxtop/2023/09/15/generic-type/" rel="bookmark" title="一文读懂Java范型">一文读懂Java范型</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="文理兼修电脑首席" data-src="/limxtop/images/avatar.jpg"><p class="name" itemprop="name">文理兼修电脑首席</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/limxtop/archives/"><span class="count">33</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/limxtop/categories/"><span class="count">3</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/limxtop/tags/"><span class="count">25</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9saW14dG9w" title="https:&#x2F;&#x2F;twitter.com&#x2F;limxtop"><i class="ic i-twitter"></i></span> <span class="exturl item email" data-url="bWFpbHRvOmxpbXh0b3BAZ21haWwuY29t" title="mailto:limxtop@gmail.com"><i class="ic i-envelope"></i></span> <span class="exturl item stackoverflow" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9saW14dG9w" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;limxtop"><i class="ic i-stack-overflow"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbS9saW14dG9w" title="https:&#x2F;&#x2F;youtube.com&#x2F;limxtop"><i class="ic i-youtube"></i></span></div><ul class="menu"><li class="item"><a href="/limxtop/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/limxtop/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/limxtop/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/limxtop/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/limxtop/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/limxtop/2023/07/29/semaphore/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/limxtop/2023/07/30/RxJava-Schedule/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2023/07/29/semaphore/" title="Semaphore">Semaphore</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2022/02/24/Android-view-canvas-%E5%9D%90%E6%A0%87%E7%B3%BB/" title="Android view &amp; canvas 坐标系">Android view & canvas 坐标系</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2023/07/08/Representing-and-Manipulating-Information/" title="数字在计算机的表示和操作">数字在计算机的表示和操作</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2022/10/19/how-to-make-money/" title="如何赚大钱">如何赚大钱</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2021/10/18/FragmentManagerV2/" title="FragmentManager源码剖析二">FragmentManager源码剖析二</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2023/01/08/azhen/" title="阿珍">阿珍</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2022/12/23/next-pole/" title="下一棒">下一棒</a></span></li><li class="item"><div class="breadcrumb"><a href="/limxtop/categories/Java/" title="In Java">Java</a></div><span><a href="/limxtop/2023/07/30/AbstractQueuedSynchronizer/" title="Java 并发框架 AbstractQueuedSynchronizer">Java 并发框架 AbstractQueuedSynchronizer</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2022/02/14/LifeCycle-LiveData/" title="LifeCycle &amp; LiveData源码剖析">LifeCycle & LiveData源码剖析</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop/2022/09/10/when-I-was-young/" title="钱很重要么？">钱很重要么？</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">文理兼修电脑首席 @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">201k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">3:03</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/07/30/AbstractQueuedSynchronizer/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/limxtop/js/app.js?v=0.2.5"></script></body></html>