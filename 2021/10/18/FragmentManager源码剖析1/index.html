<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/limxtop1989.github.io/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/limxtop1989.github.io/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="若批评不自由，则赞美无意义" href="https://limxtop1989.github.io/limxtop1989.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="若批评不自由，则赞美无意义" href="https://limxtop1989.github.io/limxtop1989.github.io/atom.xml"><link rel="alternate" type="application/json" title="若批评不自由，则赞美无意义" href="https://limxtop1989.github.io/limxtop1989.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/limxtop1989.github.io/css/app.css?v=0.2.5"><link rel="canonical" href="https://limxtop1989.github.io/limxtop1989.github.io/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/"><title>FragmentManager 源码剖析一 | Yume Shoka = 若批评不自由，则赞美无意义 = 程序员 & 文艺青年的后花园</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">FragmentManager 源码剖析一</h1><div class="meta"><span class="item" title="Created: 2021-10-18 21:23:33"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2021-10-18T21:23:33+08:00">2021-10-18</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>29k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>26 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/limxtop1989.github.io/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciszlczyj20zk0m816d.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeybxm1pj20zk0m8niv.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciukx8a7j20zk0m8aio.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipex2cdtbj20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicm0fdw5cj20zk0m8hdt.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/limxtop1989.github.io/">Home</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://limxtop1989.github.io/limxtop1989.github.io/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/limxtop1989.github.io/images/avatar.jpg"><meta itemprop="name" content="文理兼修电脑首席"><meta itemprop="description" content="程序员 & 文艺青年的后花园, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="若批评不自由，则赞美无意义"></span><div class="body md" itemprop="articleBody"><h1 id="总结"><a class="anchor" href="#总结">#</a> 总结</h1><ol><li>使用 Fragment 的 Activity 需要继承 <code>FragmentActivity</code> 这里有派发生命周期方法给 FragmentManager，再派发给旗下 Fragment。</li><li>加入 Fragment 时，需要判断 <code>savedInstanceState == null</code> ，避免重复创建实例。</li><li>add Fragment，初始时，其 Fragment 生命周期方法会被升级到 onStart 状态，随后与 FragmentManager 的状态同步，如果宿主 Activity 是 Resume 状态，则同步至 onResume 状态。</li><li>detach fragment，其生命周期方法会被降级到 onDestroyView。</li><li>remove fragment，其生命周期方法会被降级到 onDestroyView 或者 onDestroy。</li><li>show or hide fragment，生命周期方法不会回调，只是切换 fragment 根 view 的可见性。</li></ol><h1 id="sample-codes"><a class="anchor" href="#sample-codes">#</a> Sample codes</h1><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ExampleActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>example_activity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token function">getSupportFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setReorderingAllowed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>fragment_container_view<span class="token punctuation">,</span> <span class="token class-name">ExampleFragment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>								<span class="token comment">// name can be null</span></pre></td></tr><tr><td data-num="13"></td><td><pre>								<span class="token punctuation">.</span><span class="token function">addToBackStack</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Note: the fragment transaction is only created when savedInstanceState is null. This is to ensure that the fragment is added only once, when the activity is first created. When a configuration change occurs and the activity is recreated, savedInstanceState is no longer null, and the fragment does not need to be added a second time, as the fragment is automatically restored from the savedInstanceState.</p><p>Note: You should always use setReorderingAllowed(true) when performing a FragmentTransaction. For more information on reordered transactions, see Fragment transactions.</p><h2 id="begintransaction"><a class="anchor" href="#begintransaction">#</a> beginTransaction</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@NonNull</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">FragmentTransaction</span> <span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BackStackRecord</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="setreorderingallowed"><a class="anchor" href="#setreorderingallowed">#</a> setReorderingAllowed</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Sets whether or not to allow optimizing operations within and across</pre></td></tr><tr><td data-num="3"></td><td><pre> * transactions. This will remove redundant operations, eliminating</pre></td></tr><tr><td data-num="4"></td><td><pre> * operations that cancel. For example, if two transactions are executed</pre></td></tr><tr><td data-num="5"></td><td><pre> * together, one that adds a fragment A and the next replaces it with fragment B,</pre></td></tr><tr><td data-num="6"></td><td><pre> * the operations will cancel and only fragment B will be added. That means that</pre></td></tr><tr><td data-num="7"></td><td><pre> * fragment A may not go through the creation/destruction lifecycle.</pre></td></tr><tr><td data-num="8"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="9"></td><td><pre> * The side effect of removing redundant operations is that fragments may have state changes</pre></td></tr><tr><td data-num="10"></td><td><pre> * out of the expected order. For example, one transaction adds fragment A,</pre></td></tr><tr><td data-num="11"></td><td><pre> * a second adds fragment B, then a third removes fragment A. Without removing the redundant</pre></td></tr><tr><td data-num="12"></td><td><pre> * operations, fragment B could expect that while it is being created, fragment A will also</pre></td></tr><tr><td data-num="13"></td><td><pre> * exist because fragment A will be removed after fragment B was added.</pre></td></tr><tr><td data-num="14"></td><td><pre> * With removing redundant operations, fragment B cannot expect fragment A to exist when</pre></td></tr><tr><td data-num="15"></td><td><pre> * it has been created because fragment A's add/remove will be optimized out.</pre></td></tr><tr><td data-num="16"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="17"></td><td><pre> * It can also reorder the state changes of Fragments to allow for better Transitions.</pre></td></tr><tr><td data-num="18"></td><td><pre> * Added Fragments may have &#123;@link Fragment#onCreate(Bundle)&#125; called before replaced</pre></td></tr><tr><td data-num="19"></td><td><pre> * Fragments have &#123;@link Fragment#onDestroy()&#125; called.</pre></td></tr><tr><td data-num="20"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="21"></td><td><pre> * &#123;@link Fragment#postponeEnterTransition()&#125; requires &#123;@code setReorderingAllowed(true)&#125;.</pre></td></tr><tr><td data-num="22"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="23"></td><td><pre> * The default is &#123;@code false&#125;.</pre></td></tr><tr><td data-num="24"></td><td><pre> *</pre></td></tr><tr><td data-num="25"></td><td><pre> * @param reorderingAllowed &#123;@code true&#125; to enable optimizing out redundant operations</pre></td></tr><tr><td data-num="26"></td><td><pre> *                          or &#123;@code false&#125; to disable optimizing out redundant</pre></td></tr><tr><td data-num="27"></td><td><pre> *                          operations on this transaction.</pre></td></tr><tr><td data-num="28"></td><td><pre> */</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token annotation punctuation">@NonNull</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">FragmentTransaction</span> <span class="token function">setReorderingAllowed</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> reorderingAllowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    mReorderingAllowed <span class="token operator">=</span> reorderingAllowed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="add"><a class="anchor" href="#add">#</a> add</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Calls &#123;@link #add(int, Fragment, String)&#125; with a 0 containerViewId.</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@NonNull</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">FragmentTransaction</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">doAddOp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fragment<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> <span class="token constant">OP_ADD</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">doAddOp</span><span class="token punctuation">(</span><span class="token keyword">int</span> containerViewId<span class="token punctuation">,</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> tag<span class="token punctuation">,</span> <span class="token keyword">int</span> opcmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> fragmentClass <span class="token operator">=</span> fragment<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">int</span> modifiers <span class="token operator">=</span> fragmentClass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentClass<span class="token punctuation">.</span><span class="token function">isAnonymousClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token operator">||</span> <span class="token punctuation">(</span>fragmentClass<span class="token punctuation">.</span><span class="token function">isMemberClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Fragment "</span> <span class="token operator">+</span> fragmentClass<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token operator">+</span> <span class="token string">" must be a public static class to be  properly recreated from"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token operator">+</span> <span class="token string">" instance state."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mTag <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>tag<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Can't change tag of fragment "</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token operator">+</span> fragment <span class="token operator">+</span> <span class="token string">": was "</span> <span class="token operator">+</span> fragment<span class="token punctuation">.</span>mTag</pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token operator">+</span> <span class="token string">" now "</span> <span class="token operator">+</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        fragment<span class="token punctuation">.</span>mTag <span class="token operator">=</span> tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>containerViewId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>containerViewId <span class="token operator">==</span> <span class="token class-name">View</span><span class="token punctuation">.</span><span class="token constant">NO_ID</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Can't add fragment "</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token operator">+</span> fragment <span class="token operator">+</span> <span class="token string">" with tag "</span> <span class="token operator">+</span> tag <span class="token operator">+</span> <span class="token string">" to container view with no id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mFragmentId <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fragment<span class="token punctuation">.</span>mFragmentId <span class="token operator">!=</span> containerViewId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Can't change container ID of fragment "</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                    <span class="token operator">+</span> fragment <span class="token operator">+</span> <span class="token string">": was "</span> <span class="token operator">+</span> fragment<span class="token punctuation">.</span>mFragmentId</pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token operator">+</span> <span class="token string">" now "</span> <span class="token operator">+</span> containerViewId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        fragment<span class="token punctuation">.</span>mContainerId <span class="token operator">=</span> fragment<span class="token punctuation">.</span>mFragmentId <span class="token operator">=</span> containerViewId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">addOp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Op</span><span class="token punctuation">(</span>opcmd<span class="token punctuation">,</span> fragment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">addOp</span><span class="token punctuation">(</span><span class="token class-name">Op</span> op<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    mOps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    op<span class="token punctuation">.</span>mEnterAnim <span class="token operator">=</span> mEnterAnim<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    op<span class="token punctuation">.</span>mExitAnim <span class="token operator">=</span> mExitAnim<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    op<span class="token punctuation">.</span>mPopEnterAnim <span class="token operator">=</span> mPopEnterAnim<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    op<span class="token punctuation">.</span>mPopExitAnim <span class="token operator">=</span> mPopExitAnim<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>传入 fragment 实例，将对 fragment 的增删换，显示隐藏等操作封装成 op，并加入 op 列表集合，作为一个操作事物。</p><h2 id="addtobackstack"><a class="anchor" href="#addtobackstack">#</a> addToBackStack</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Add this transaction to the back stack.  This means that the transaction</pre></td></tr><tr><td data-num="3"></td><td><pre> * will be remembered after it is committed, and will reverse its operation</pre></td></tr><tr><td data-num="4"></td><td><pre> * when later popped off the stack.</pre></td></tr><tr><td data-num="5"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="6"></td><td><pre> * &#123;@link #setReorderingAllowed(boolean)&#125; must be set to &lt;code>true&lt;/code></pre></td></tr><tr><td data-num="7"></td><td><pre> * in the same transaction as addToBackStack() to allow the pop of that</pre></td></tr><tr><td data-num="8"></td><td><pre> * transaction to be reordered.</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * @param name An optional name for this back stack state, or null.</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@NonNull</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">FragmentTransaction</span> <span class="token function">addToBackStack</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAllowAddToBackStack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token string">"This FragmentTransaction is not allowed to be added to the back stack."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    mAddToBackStack <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    mName <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>addToBackStack 更新 mAddToBackStack 标记位，并保存 backStack 名字，作为未来回退到此 backStack 的标示。</p><h2 id="commit"><a class="anchor" href="#commit">#</a> commit</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>BackStackRecord</span>#commitInternal</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">commitInternal</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCommitted<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"commit already called"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    mCommitted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAddToBackStack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        mIndex <span class="token operator">=</span> mManager<span class="token punctuation">.</span><span class="token function">allocBackStackIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        mIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    mManager<span class="token punctuation">.</span><span class="token function">enqueueAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> allowStateLoss<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> mIndex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>如果加入 backStack，则分配一个在 backStack 的索引，然后将此事务加入提交队列，等待主线程调度提交。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#enqueueAction</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Adds an action to the queue of pending actions.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param action the action to add</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param allowStateLoss whether to allow loss of state information</pre></td></tr><tr><td data-num="8"></td><td><pre> * @throws IllegalStateException if the activity has been destroyed</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueAction</span><span class="token punctuation">(</span><span class="token class-name">OpGenerator</span> action<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">checkStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDestroyed <span class="token operator">||</span> mHost <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token comment">// This FragmentManager isn't attached, so drop the entire transaction.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Activity has been destroyed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingActions <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            mPendingActions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        mPendingActions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">scheduleCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="opgenerator"><a class="anchor" href="#opgenerator">#</a> OpGenerator</h2><p>BackStackRecord 实现 OpGenerator 接口，先看下方法实现内容：将本次事务加入事务集合。并且判断如果要支持回退栈，则加入回退栈集合。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>BackStackRecord</span>#generateOps</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Implementation of &#123;@link FragmentManagerImpl.OpGenerator&#125;.</pre></td></tr><tr><td data-num="5"></td><td><pre> * This operation is added to the list of pending actions during &#123;@link #commit()&#125;, and</pre></td></tr><tr><td data-num="6"></td><td><pre> * will be executed on the UI thread to run this FragmentTransaction.</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * @param records Modified to add this BackStackRecord</pre></td></tr><tr><td data-num="9"></td><td><pre> * @param isRecordPop Modified to add a false (this isn't a pop)</pre></td></tr><tr><td data-num="10"></td><td><pre> * @return true always because the records and isRecordPop will always be changed</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">generateOps</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isRecordPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FragmentManagerImpl</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Run: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    records<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    isRecordPop<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAddToBackStack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        mManager<span class="token punctuation">.</span><span class="token function">addBackStackState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#addBackStackState</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">addBackStackState</span><span class="token punctuation">(</span><span class="token class-name">BackStackRecord</span> state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBackStack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        mBackStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    mBackStack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="schedulecommit"><a class="anchor" href="#schedulecommit">#</a> scheduleCommit</h1><h2 id="ensureexecready"><a class="anchor" href="#ensureexecready">#</a> ensureExecReady</h2><p>条件检查，并实例化 mTmpRecords &amp; mTmpIsPop。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#execPendingActions</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Only call from main thread!</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">ensureExecReady</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1. Init mTmpRecords &amp; mTmpIsPop</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 2. Copy BackStackRecord  in mPendingActions into mTmpRecords， so does mTmpIsPop </span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">generateOpsForPendingActions</span><span class="token punctuation">(</span>mTmpRecords<span class="token punctuation">,</span> mTmpIsPop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        mExecutingActions <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>						<span class="token comment">// 3. </span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token function">removeRedundantOperationsAndExecute</span><span class="token punctuation">(</span>mTmpRecords<span class="token punctuation">,</span> mTmpIsPop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token function">cleanupExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">updateOnBackPressedCallbackEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">doPendingDeferredStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">burpActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="generateopsforpendingactions"><a class="anchor" href="#generateopsforpendingactions">#</a> generateOpsForPendingActions</h2><p>将 mPendingActions 的 BackStackRecord，即我们提交的事务集合，复制到 records（即成员变量 mTmpRecords，mTmpIsPop 同理）</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#generateOpsForPendingActions</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Adds all records in the pending actions to records and whether they are add or pop</pre></td></tr><tr><td data-num="5"></td><td><pre> * operations to isPop. After executing, the pending actions will be empty.</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param records All pending actions will generate BackStackRecords added to this.</pre></td></tr><tr><td data-num="8"></td><td><pre> *                This contains the transactions, in order, to execute.</pre></td></tr><tr><td data-num="9"></td><td><pre> * @param isPop All pending actions will generate booleans to add to this. This contains</pre></td></tr><tr><td data-num="10"></td><td><pre> *              an entry for each entry in records to indicate whether or not it is a</pre></td></tr><tr><td data-num="11"></td><td><pre> *              pop action.</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">generateOpsForPendingActions</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                                             <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingActions <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mPendingActions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">int</span> numActions <span class="token operator">=</span> mPendingActions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numActions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            didSomething <span class="token operator">|=</span> mPendingActions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateOps</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> isPop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        mPendingActions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        mHost<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mExecCommit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="removeredundantoperationsandexecute"><a class="anchor" href="#removeredundantoperationsandexecute">#</a> removeRedundantOperationsAndExecute</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#removeRedundantOperationsAndExecute</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Remove redundant BackStackRecord operations and executes them. This method merges operations</pre></td></tr><tr><td data-num="5"></td><td><pre> * of proximate records that allow reordering. See</pre></td></tr><tr><td data-num="6"></td><td><pre> * &#123;@link FragmentTransaction#setReorderingAllowed(boolean)&#125;.</pre></td></tr><tr><td data-num="7"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="8"></td><td><pre> * For example, a transaction that adds to the back stack and then another that pops that</pre></td></tr><tr><td data-num="9"></td><td><pre> * back stack record will be optimized to remove the unnecessary operation.</pre></td></tr><tr><td data-num="10"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="11"></td><td><pre> * Likewise, two transactions committed that are executed at the same time will be optimized</pre></td></tr><tr><td data-num="12"></td><td><pre> * to remove the redundant operations as well as two pop operations executed together.</pre></td></tr><tr><td data-num="13"></td><td><pre> *</pre></td></tr><tr><td data-num="14"></td><td><pre> * @param records The records pending execution</pre></td></tr><tr><td data-num="15"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num="16"></td><td><pre> */</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeRedundantOperationsAndExecute</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                                                 <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isRecordPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>records <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> records<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRecordPop <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> records<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> isRecordPop<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Internal error with the back stack records"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// Force start of any postponed transactions that interact with scheduled transactions:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">executePostponedTransaction</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> isRecordPop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">int</span> numRecords <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">int</span> startIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> recordNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> recordNum <span class="token operator">&lt;</span> numRecords<span class="token punctuation">;</span> recordNum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> canReorder <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recordNum<span class="token punctuation">)</span><span class="token punctuation">.</span>mReorderingAllowed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>canReorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token comment">// execute all previous transactions</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">!=</span> recordNum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token function">executeOpsTogether</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> isRecordPop<span class="token punctuation">,</span> startIndex<span class="token punctuation">,</span> recordNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token comment">// execute all pop operations that don't allow reordering together or</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token comment">// one add operation</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token keyword">int</span> reorderingEnd <span class="token operator">=</span> recordNum <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isRecordPop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recordNum<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token keyword">while</span> <span class="token punctuation">(</span>reorderingEnd <span class="token operator">&lt;</span> numRecords</pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token operator">&amp;&amp;</span> isRecordPop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>reorderingEnd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>reorderingEnd<span class="token punctuation">)</span><span class="token punctuation">.</span>mReorderingAllowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                    reorderingEnd<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token function">executeOpsTogether</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> isRecordPop<span class="token punctuation">,</span> recordNum<span class="token punctuation">,</span> reorderingEnd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            startIndex <span class="token operator">=</span> reorderingEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            recordNum <span class="token operator">=</span> reorderingEnd <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>		<span class="token comment">// Reorder is true as example code. Pay attention here.</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">!=</span> numRecords<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>				<span class="token comment">//startIndex 为 0， numRecords 为批处理的事务个数。</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token function">executeOpsTogether</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> isRecordPop<span class="token punctuation">,</span> startIndex<span class="token punctuation">,</span> numRecords<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="executeopstogether"><a class="anchor" href="#executeopstogether">#</a> executeOpsTogether</h2><p>一般推荐允许重排序，看最后一行方法调用 executeOpsTogether。从 API 描述看，它执行事务集合的子集，子集里事务要么是允许重排序，要么不允许。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#executeOpsTogether</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Executes a subset of a list of BackStackRecords, all of which either allow reordering or</pre></td></tr><tr><td data-num="5"></td><td><pre> * do not allow ordering.</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param records A list of BackStackRecords that are to be executed</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num="8"></td><td><pre> * @param startIndex The index of the first record in &lt;code>records&lt;/code> to be executed</pre></td></tr><tr><td data-num="9"></td><td><pre> * @param endIndex One more than the final record index in &lt;code>records&lt;/code> to executed.</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeOpsTogether</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isRecordPop<span class="token punctuation">,</span> <span class="token keyword">int</span> startIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowReordering <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">)</span><span class="token punctuation">.</span>mReorderingAllowed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">boolean</span> addToBackStack <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTmpAddedFragments <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        mTmpAddedFragments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        mTmpAddedFragments<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token comment">// 执行 transaction.add (fragment)，事务完成后，fragment 会加入 mAdded 集合内，</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token comment">//activity 生命周期方法派发给 FragmentManager，继而派发给 mAdded 集合内的 Fragment</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token comment">// 此处复制已添加 Fragment 集合到临时变量，</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    mTmpAddedFragments<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mFragmentStore<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token class-name">Fragment</span> oldPrimaryNav <span class="token operator">=</span> <span class="token function">getPrimaryNavigationFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> recordNum <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> recordNum <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> recordNum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">BackStackRecord</span> record <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recordNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPop <span class="token operator">=</span> isRecordPop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recordNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>						<span class="token comment">// 这里将 op 替换为更原子的操作，如 replace 拆解为 remove &amp; add，并将 ops 内的 fragment</span></pre></td></tr><tr><td data-num="30"></td><td><pre>						<span class="token comment">// 依照 op 的 cmd 命令，从 mTmpAddedFragments add 或 remove op 里的 fragment，</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            oldPrimaryNav <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">expandOps</span><span class="token punctuation">(</span>mTmpAddedFragments<span class="token punctuation">,</span> oldPrimaryNav<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            oldPrimaryNav <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">trackAddedFragmentsInPop</span><span class="token punctuation">(</span>mTmpAddedFragments<span class="token punctuation">,</span> oldPrimaryNav<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        addToBackStack <span class="token operator">=</span> addToBackStack <span class="token operator">||</span> record<span class="token punctuation">.</span>mAddToBackStack<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    mTmpAddedFragments<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowReordering <span class="token operator">&amp;&amp;</span> mCurState <span class="token operator">>=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 一般推荐重排序，此处代码省略</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">// 1. 遍历 BackStackRecord 集合，逐个执行事务：将 Fragment 发送给 FragmentManager 管理，并更新 Fragment 标记。</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">executeOps</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> isRecordPop<span class="token punctuation">,</span> startIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">USE_STATE_MANAGER</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// The last operation determines the overall direction, this ensures that operations</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token comment">// such as push, push, pop, push are correctly considered a push</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">boolean</span> isPop <span class="token operator">=</span> isRecordPop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// Ensure that Fragments directly affected by operations</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">// are moved to their expected state in operation order</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> index <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token class-name">BackStackRecord</span> record <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token comment">// Pop operations get applied in reverse order</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> opIndex <span class="token operator">=</span> record<span class="token punctuation">.</span>mOps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> opIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> opIndex<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    <span class="token class-name">FragmentTransaction<span class="token punctuation">.</span>Op</span> op <span class="token operator">=</span> record<span class="token punctuation">.</span>mOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>opIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                    <span class="token class-name">Fragment</span> fragment <span class="token operator">=</span> op<span class="token punctuation">.</span>mFragment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">=</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                                <span class="token function">createOrGetFragmentStateManager</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FragmentTransaction<span class="token punctuation">.</span>Op</span> op <span class="token operator">:</span> record<span class="token punctuation">.</span>mOps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                    <span class="token class-name">Fragment</span> fragment <span class="token operator">=</span> op<span class="token punctuation">.</span>mFragment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                        <span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">=</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                                <span class="token function">createOrGetFragmentStateManager</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>												<span class="token comment">// 2. 事务内的 Fragment 推送至默认状态</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token comment">// And only then do we move all other fragments to the current state</span></pre></td></tr><tr><td data-num="78"></td><td><pre>				<span class="token comment">// 3. 将 Fragment 全部推送到当前 FragmentManager 的状态。</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token function">moveToState</span><span class="token punctuation">(</span>mCurState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecialEffectsController</span><span class="token punctuation">></span></span> changedControllers <span class="token operator">=</span> <span class="token function">collectChangedControllers</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                records<span class="token punctuation">,</span> startIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SpecialEffectsController</span> controller <span class="token operator">:</span> changedControllers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            controller<span class="token punctuation">.</span><span class="token function">updateOperationDirection</span><span class="token punctuation">(</span>isPop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            controller<span class="token punctuation">.</span><span class="token function">markPostponedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            controller<span class="token punctuation">.</span><span class="token function">executePendingOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token comment">// USE_STATE_MANAGER 默认为 true，此处代码省略</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>		<span class="token comment">// 调用每个事务的提交监听回掉</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> recordNum <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> recordNum <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> recordNum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">BackStackRecord</span> record <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recordNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPop <span class="token operator">=</span> isRecordPop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recordNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPop <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>mIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>            record<span class="token punctuation">.</span>mIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        record<span class="token punctuation">.</span><span class="token function">runOnCommitRunnables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>		<span class="token comment">//// 通知 backStack 变更的监听回掉</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>addToBackStack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token function">reportBackStackChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="executeops"><a class="anchor" href="#executeops">#</a> executeOps</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#executeOps</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Run the operations in the BackStackRecords, either to push or pop.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param records The list of records whose operations should be run.</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num="8"></td><td><pre> * @param startIndex The index of the first entry in records to run.</pre></td></tr><tr><td data-num="9"></td><td><pre> * @param endIndex One past the index of the final entry in records to run.</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">executeOps</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                               <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isRecordPop<span class="token punctuation">,</span> <span class="token keyword">int</span> startIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">BackStackRecord</span> record <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPop <span class="token operator">=</span> isRecordPop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            record<span class="token punctuation">.</span><span class="token function">bumpBackStackNesting</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// Only execute the add operations at the end of</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">// all transactions.</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">boolean</span> moveToState <span class="token operator">=</span> i <span class="token operator">==</span> <span class="token punctuation">(</span>endIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            record<span class="token punctuation">.</span><span class="token function">executePopOps</span><span class="token punctuation">(</span>moveToState<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            record<span class="token punctuation">.</span><span class="token function">bumpBackStackNesting</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            record<span class="token punctuation">.</span><span class="token function">executeOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>遍历事务 Op 集合，逐个执行事务里的 Op</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>BackStackRecord</span>#executeOps</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Executes the operations contained within this transaction. The Fragment states will only</pre></td></tr><tr><td data-num="5"></td><td><pre> * be modified if optimizations are not allowed.</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">executeOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">int</span> numOps <span class="token operator">=</span> mOps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> opNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> opNum <span class="token operator">&lt;</span> numOps<span class="token punctuation">;</span> opNum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">Op</span> op <span class="token operator">=</span> mOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>opNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">Fragment</span> f <span class="token operator">=</span> op<span class="token punctuation">.</span>mFragment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setPopDirection</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setAnimations</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>mEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mExitAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopExitAnim<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setNextTransition</span><span class="token punctuation">(</span>mTransition<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setSharedElementNames</span><span class="token punctuation">(</span>mSharedElementSourceNames<span class="token punctuation">,</span> mSharedElementTargetNames<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>mCmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_ADD</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setExitAnimationOrder</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">addFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_REMOVE</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">removeFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_HIDE</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">hideFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_SHOW</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setExitAnimationOrder</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">showFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_DETACH</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">detachFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_ATTACH</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setExitAnimationOrder</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">attachFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_SET_PRIMARY_NAV</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setPrimaryNavigationFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_UNSET_PRIMARY_NAV</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setPrimaryNavigationFragment</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">OP_SET_MAX_LIFECYCLE</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setMaxLifecycle</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mCurrentMaxState<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unknown cmd: "</span> <span class="token operator">+</span> op<span class="token punctuation">.</span>mCmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>				<span class="token comment">// 允许排序，以下代码不执行</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mReorderingAllowed <span class="token operator">&amp;&amp;</span> op<span class="token punctuation">.</span>mCmd <span class="token operator">!=</span> <span class="token constant">OP_ADD</span> <span class="token operator">&amp;&amp;</span> f <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token constant">USE_STATE_MANAGER</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mReorderingAllowed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token constant">USE_STATE_MANAGER</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token comment">// Added fragments are added at the end to comply with prior behavior.</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        mManager<span class="token punctuation">.</span><span class="token function">moveToState</span><span class="token punctuation">(</span>mManager<span class="token punctuation">.</span>mCurState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>addFragment &amp; removeFragment 主要是操作 mAdded fragment 集合并更新 fragment.mRemoving &amp; fragment.mAdded 标记</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#removeFragment</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">removeFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"remove: "</span> <span class="token operator">+</span> fragment <span class="token operator">+</span> <span class="token string">" nesting="</span> <span class="token operator">+</span> fragment<span class="token punctuation">.</span>mBackStackNesting<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> inactive <span class="token operator">=</span> <span class="token operator">!</span>fragment<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached <span class="token operator">||</span> inactive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        mFragmentStore<span class="token punctuation">.</span><span class="token function">removeFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        fragment<span class="token punctuation">.</span>mRemoving <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function">setVisibleRemovingFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#addFragment</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token class-name">FragmentStateManager</span> <span class="token function">addFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"add: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">=</span> <span class="token function">createOrGetFragmentStateManager</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    fragment<span class="token punctuation">.</span>mFragmentManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    mFragmentStore<span class="token punctuation">.</span><span class="token function">makeActive</span><span class="token punctuation">(</span>fragmentStateManager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        mFragmentStore<span class="token punctuation">.</span><span class="token function">addFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        fragment<span class="token punctuation">.</span>mRemoving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            fragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">return</span> fragmentStateManager<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>attachFragment 与 addFragment 的差异：</p><ol><li>无 makeActive (fragment)，这个差异导致两者的 Fragment 默认升级到 started 状态后，只有 add fragment 会继续与 FragmentManager 状态同步，接收 FragmentManager 生命周期方法的派发，attach fragment 则到此戛然而止。也没有 moveToState (fragment) 操作（addFragment 下，此方法不调用，传入 moveToStateNow 参数值为 false）</li><li>只有之前 detach 操作过，attach 才有效果。</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#attachFragment</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">attachFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"attach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>				<span class="token comment">// 初始化时，mDetached 为 false，只有 detachFragment 才置为 true。</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        fragment<span class="token punctuation">.</span>mDetached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            mFragmentStore<span class="token punctuation">.</span><span class="token function">addFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"add from attach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentStore</span>#addFragment</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">void</span> <span class="token function">addFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Fragment already added: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        mAdded<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    fragment<span class="token punctuation">.</span>mAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>remove &amp; detachFragment 都将 fragment 从 mAdded 集合移除 fragment，不同的是分别标记 mRemoving &amp; mDetached 为 true。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">removeFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"remove: "</span> <span class="token operator">+</span> fragment <span class="token operator">+</span> <span class="token string">" nesting="</span> <span class="token operator">+</span> fragment<span class="token punctuation">.</span>mBackStackNesting<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> inactive <span class="token operator">=</span> <span class="token operator">!</span>fragment<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached <span class="token operator">||</span> inactive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        mFragmentStore<span class="token punctuation">.</span><span class="token function">removeFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        fragment<span class="token punctuation">.</span>mRemoving <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">setVisibleRemovingFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token function">removeFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        mAdded<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    fragment<span class="token punctuation">.</span>mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">detachFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"detach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        fragment<span class="token punctuation">.</span>mDetached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token comment">// We are not already in back stack, so need to remove the fragment.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"remove from detach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            mFragmentStore<span class="token punctuation">.</span><span class="token function">removeFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token function">setVisibleRemovingFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>showFrament &amp; hideFragment 主要更新 mHidden 标记</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Marks a fragment as hidden to be later animated in with</pre></td></tr><tr><td data-num="3"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">hideFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"hide: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        fragment<span class="token punctuation">.</span>mHidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        fragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token operator">!</span>fragment<span class="token punctuation">.</span>mHiddenChanged<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">setVisibleRemovingFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre> * Marks a fragment as shown to be later animated in with</pre></td></tr><tr><td data-num="20"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num="21"></td><td><pre> *</pre></td></tr><tr><td data-num="22"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num="23"></td><td><pre> */</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">void</span> <span class="token function">showFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"show: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        fragment<span class="token punctuation">.</span>mHidden <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        fragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token operator">!</span>fragment<span class="token punctuation">.</span>mHiddenChanged<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Fragment 主要标记</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// True if the fragment is in the list of added fragments.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">boolean</span> mAdded<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// If set this fragment is being removed from its activity.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">boolean</span> mRemoving<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// Set to true when the app has requested that this fragment be hidden</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// from the user.</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">boolean</span> mHidden<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// Set to true when the app has requested that this fragment be deactivated.</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">boolean</span> mDetached<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="movetoexpectedstate"><a class="anchor" href="#movetoexpectedstate">#</a> moveToExpectedState</h3><p>遍历事务集合，将事务内每个 op 对应的 Fragment 推送到合适的状态，具体状态值在 computeExpectedState 计算。默认是当前 FragmentManager 的状态。但会根据 Fragment 标记重算。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Assume the Fragment can go as high as the FragmentManager's state</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> maxState <span class="token operator">=</span> mFragmentManagerState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Fragments that are not currently added will sit in the CREATED state.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//detach &amp; remove 操作的 fragment，目标状态是 CREATED</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mFragment<span class="token punctuation">.</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    maxState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxState<span class="token punctuation">,</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mRemoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// Fragments on the back stack shouldn't go higher than CREATED</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        maxState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxState<span class="token punctuation">,</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// While removing a fragment, we always move to INITIALIZING</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				<span class="token comment">//remove 操作的 Fragment，如果不在回退栈，目标状态是 INITIALIZING</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        maxState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxState<span class="token punctuation">,</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mMovingToState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">VERBOSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Ignoring re-entrant call to "</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                        <span class="token operator">+</span> <span class="token string">"moveToExpectedState() for "</span> <span class="token operator">+</span> <span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            mMovingToState <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">int</span> newState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newState <span class="token operator">=</span> <span class="token function">computeExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mFragment<span class="token punctuation">.</span>mState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">></span> mFragment<span class="token punctuation">.</span>mState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token comment">// Moving upward</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    <span class="token keyword">int</span> nextStep <span class="token operator">=</span> mFragment<span class="token punctuation">.</span>mState <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>nextStep<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ATTACHED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                            <span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                            <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">VIEW_CREATED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                            <span class="token function">ensureInflatedView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                            <span class="token function">createView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">AWAITING_EXIT_EFFECTS</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                            <span class="token function">activityCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_CREATED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mView <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mFragment<span class="token punctuation">.</span>mContainer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                                <span class="token class-name">SpecialEffectsController</span> controller <span class="token operator">=</span> <span class="token class-name">SpecialEffectsController</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                                        <span class="token punctuation">.</span><span class="token function">getOrCreateController</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mContainer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                                                mFragment<span class="token punctuation">.</span><span class="token function">getParentFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                                <span class="token keyword">int</span> visibility <span class="token operator">=</span> mFragment<span class="token punctuation">.</span>mView<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                                <span class="token class-name">SpecialEffectsController<span class="token punctuation">.</span>Operation<span class="token punctuation">.</span>State</span> finalState <span class="token operator">=</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                                        <span class="token class-name">SpecialEffectsController<span class="token punctuation">.</span>Operation<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>visibility<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                                controller<span class="token punctuation">.</span><span class="token function">enqueueAdd</span><span class="token punctuation">(</span>finalState<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                            mFragment<span class="token punctuation">.</span>mState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_CREATED</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">STARTED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                            <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">AWAITING_ENTER_EFFECTS</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                            mFragment<span class="token punctuation">.</span>mState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">AWAITING_ENTER_EFFECTS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">RESUMED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                            <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    <span class="token comment">// Moving downward</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    <span class="token keyword">int</span> nextStep <span class="token operator">=</span> mFragment<span class="token punctuation">.</span>mState <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>nextStep<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">AWAITING_ENTER_EFFECTS</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                            <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">STARTED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                            mFragment<span class="token punctuation">.</span>mState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">STARTED</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_CREATED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                            <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">AWAITING_EXIT_EFFECTS</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token function">isLoggingEnabled</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"movefrom ACTIVITY_CREATED: "</span> <span class="token operator">+</span> mFragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mView <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                                <span class="token comment">// Need to save the current view state if not done already</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                                <span class="token comment">// by saveInstanceState()</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mSavedViewState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                                    <span class="token function">saveViewState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mView <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mFragment<span class="token punctuation">.</span>mContainer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                                <span class="token class-name">SpecialEffectsController</span> controller <span class="token operator">=</span> <span class="token class-name">SpecialEffectsController</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                                        <span class="token punctuation">.</span><span class="token function">getOrCreateController</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mContainer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                                                mFragment<span class="token punctuation">.</span><span class="token function">getParentFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                                controller<span class="token punctuation">.</span><span class="token function">enqueueRemove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                            mFragment<span class="token punctuation">.</span>mState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">AWAITING_EXIT_EFFECTS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">VIEW_CREATED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                            mFragment<span class="token punctuation">.</span>mInLayout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                            mFragment<span class="token punctuation">.</span>mState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">VIEW_CREATED</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                            <span class="token function">destroyFragmentView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                            mFragment<span class="token punctuation">.</span>mState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ATTACHED</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                            <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                        <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                            <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token constant">USE_STATE_MANAGER</span> <span class="token operator">&amp;&amp;</span> mFragment<span class="token punctuation">.</span>mHiddenChanged<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mView <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mFragment<span class="token punctuation">.</span>mContainer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                    <span class="token comment">// Get the controller and enqueue the show/hide</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                    <span class="token class-name">SpecialEffectsController</span> controller <span class="token operator">=</span> <span class="token class-name">SpecialEffectsController</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">getOrCreateController</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mContainer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                                    mFragment<span class="token punctuation">.</span><span class="token function">getParentFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                        controller<span class="token punctuation">.</span><span class="token function">enqueueHide</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                        controller<span class="token punctuation">.</span><span class="token function">enqueueShow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mFragmentManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                    mFragment<span class="token punctuation">.</span>mFragmentManager<span class="token punctuation">.</span><span class="token function">invalidateMenuForFragment</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>                mFragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>                mFragment<span class="token punctuation">.</span><span class="token function">onHiddenChanged</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>            mMovingToState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#<span class="token function">moveToState</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * Changes the state of the fragment manager to &#123;@code newState&#125;. If the fragment manager</pre></td></tr><tr><td data-num="4"></td><td><pre> * changes state or &#123;@code always&#125; is &#123;@code true&#125;, any fragments within it have their</pre></td></tr><tr><td data-num="5"></td><td><pre> * states updated as well.</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param newState The new state for the fragment manager</pre></td></tr><tr><td data-num="8"></td><td><pre> * @param always If &#123;@code true&#125;, all fragments update their state, even</pre></td></tr><tr><td data-num="9"></td><td><pre> *               if &#123;@code newState&#125; matches the current fragment manager's state.</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveToState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">,</span> <span class="token keyword">boolean</span> always<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHost <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newState <span class="token operator">!=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>always <span class="token operator">&amp;&amp;</span> newState <span class="token operator">==</span> mCurState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    mCurState <span class="token operator">=</span> newState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">USE_STATE_MANAGER</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        mFragmentStore<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Fragment</span> f <span class="token operator">:</span> mFragmentStore<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// and detached.</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                mFragmentStore<span class="token punctuation">.</span><span class="token function">getActiveFragmentStateManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token class-name">Fragment</span> f <span class="token operator">=</span> fragmentStateManager<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">.</span>mIsNewlyAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">boolean</span> beingRemoved <span class="token operator">=</span> f<span class="token punctuation">.</span>mRemoving <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>beingRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                mFragmentStore<span class="token punctuation">.</span><span class="token function">makeInactive</span><span class="token punctuation">(</span>fragmentStateManager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">startPendingDeferredFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mNeedMenuInvalidate <span class="token operator">&amp;&amp;</span> mHost <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mCurState <span class="token operator">==</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">RESUMED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        mHost<span class="token punctuation">.</span><span class="token function">onSupportInvalidateOptionsMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>同步 FragmentManager 的状态到 mActive 集合里的 Fragments，mAdded 集合的不同步。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentStore</span>#moveToExpectedState</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Fragment</span> f <span class="token operator">:</span> mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">=</span> mActive<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>mWho<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentStateManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            fragmentStateManager<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// and detached.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">:</span> mActive<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentStateManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            fragmentStateManager<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">Fragment</span> f <span class="token operator">=</span> fragmentStateManager<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">boolean</span> beingRemoved <span class="token operator">=</span> f<span class="token punctuation">.</span>mRemoving <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>beingRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token function">makeInactive</span><span class="token punctuation">(</span>fragmentStateManager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>将当前 Fragment 的状态沿着下方箭头方向升级（curState &lt;newState），或降级 (curState&gt; newState) 至 newState，（想象状态值是一个等腰三角形，resumed 在上方顶点，created &amp; destroyed 位于下方两端。从左顶点到上顶点是升级，上顶点到右顶点是降级）状态值如下，RESUMED 状态值最大。当前 newState 参数值为 STARTED。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INITIALIZING</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// Not yet created.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CREATED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">// Created.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ACTIVITY_CREATED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Fully created, not started.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STARTED</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// Created and started, not resumed.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RESUMED</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>          <span class="token comment">// Created started and resumed.</span></pre></td></tr></table></figure><p><img data-src="https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png" alt="https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png"></p><p>由上可见，Fragment 添加后，首先推送升级到 STARTED 状态。</p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-07-23 18:38:56" itemprop="dateModified" datetime="2022-07-23T18:38:56+08:00">2022-07-23</time> </span><span id="2021/10/18/FragmentManager源码剖析1/" class="item leancloud_visitors" data-flag-title="FragmentManager 源码剖析一" title="Views"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">Views</span> <span class="leancloud-visitors-count"></span> <span class="text">times</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/limxtop1989.github.io/images/wechatpay.png" alt="文理兼修电脑首席 WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/limxtop1989.github.io/images/alipay.png" alt="文理兼修电脑首席 Alipay"><p>Alipay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>文理兼修电脑首席 <i class="ic i-at"><em>@</em></i>若批评不自由，则赞美无意义</li><li class="link"><strong>Post link: </strong><a href="https://limxtop1989.github.io/limxtop1989.github.io/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/" title="FragmentManager 源码剖析一">https://limxtop1989.github.io/limxtop1989.github.io/2021/10/18/FragmentManager源码剖析1/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/limxtop1989.github.io/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclgi503lj20zk0m8hdt.jpg" title="ViewModel源码剖析"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>ViewModel源码剖析</h3></a></div><div class="item right"><a href="/limxtop1989.github.io/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclgi503lj20zk0m8hdt.jpg" title="FragmentManager源码剖析二"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>FragmentManager源码剖析二</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sample-codes"><span class="toc-number">2.</span> <span class="toc-text">Sample codes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#begintransaction"><span class="toc-number">2.1.</span> <span class="toc-text">beginTransaction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setreorderingallowed"><span class="toc-number">2.2.</span> <span class="toc-text">setReorderingAllowed</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#add"><span class="toc-number">2.3.</span> <span class="toc-text">add</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addtobackstack"><span class="toc-number">2.4.</span> <span class="toc-text">addToBackStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#commit"><span class="toc-number">2.5.</span> <span class="toc-text">commit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opgenerator"><span class="toc-number">2.6.</span> <span class="toc-text">OpGenerator</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#schedulecommit"><span class="toc-number">3.</span> <span class="toc-text">scheduleCommit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ensureexecready"><span class="toc-number">3.1.</span> <span class="toc-text">ensureExecReady</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#generateopsforpendingactions"><span class="toc-number">3.2.</span> <span class="toc-text">generateOpsForPendingActions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#removeredundantoperationsandexecute"><span class="toc-number">3.3.</span> <span class="toc-text">removeRedundantOperationsAndExecute</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#executeopstogether"><span class="toc-number">3.4.</span> <span class="toc-text">executeOpsTogether</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#executeops"><span class="toc-number">3.4.1.</span> <span class="toc-text">executeOps</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#movetoexpectedstate"><span class="toc-number">3.4.2.</span> <span class="toc-text">moveToExpectedState</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="文理兼修电脑首席" data-src="/limxtop1989.github.io/images/avatar.jpg"><p class="name" itemprop="name">文理兼修电脑首席</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/limxtop1989.github.io/archives/"><span class="count">11</span> <span class="name">posts</span></a></div><div class="item tags"><a href="/limxtop1989.github.io/tags/"><span class="count">8</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9saW14dG9w" title="https:&#x2F;&#x2F;twitter.com&#x2F;limxtop"><i class="ic i-twitter"></i></span></div><ul class="menu"><li class="item"><a href="/limxtop1989.github.io/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/limxtop1989.github.io/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/limxtop1989.github.io/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/limxtop1989.github.io/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/limxtop1989.github.io/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/limxtop1989.github.io/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/limxtop1989.github.io/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2022/09/10/Java-IO/" title="Java IO">Java IO</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2022/07/24/Android-animation-principles/" title="Android 动画原理">Android 动画原理</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2022/02/24/Android-view-canvas-%E5%9D%90%E6%A0%87%E7%B3%BB/" title="Android view &amp; canvas 坐标系">Android view & canvas 坐标系</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" title="FragmentManager源码剖析二">FragmentManager源码剖析二</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2021/08/18/English-introduction/" title="English-introduction">English-introduction</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2022/09/10/when-I-was-young/" title="钱很重要么？">钱很重要么？</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2022/08/19/android-touch-event/" title="Android Touch Event Dispatch">Android Touch Event Dispatch</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2021/07/17/activity-transfer-detection/" title="Android Activity 转移类型检测">Android Activity 转移类型检测</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="LifeCycle &amp; LiveData源码剖析">LifeCycle & LiveData源码剖析</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/limxtop1989.github.io/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="ViewModel源码剖析">ViewModel源码剖析</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">文理兼修电脑首席 @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">99k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">1:30</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/10/18/FragmentManager源码剖析1/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/limxtop1989.github.io/js/app.js?v=0.2.5"></script></body></html>