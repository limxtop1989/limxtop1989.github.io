<!DOCTYPE html><html><head><meta charset="utf-8"><title>FragmentManager源码剖析二 | 若批评不自由，则赞美无意义</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="# remove &amp; detach Fragment 差别 public void removeFragment(Fragment fragment) &amp;#123;    if (DEBUG) Log.v(TAG, &quot;remove: &quot; + fragment + &quot; nesting&#x3D;&quot; + fragment.mBackStackNesting);    final boolean inac"><meta property="og:type" content="article"><meta property="og:title" content="FragmentManager源码剖析二"><meta property="og:url" content="https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/index.html"><meta property="og:site_name" content="若批评不自由，则赞美无意义"><meta property="og:description" content="# remove &amp; detach Fragment 差别 public void removeFragment(Fragment fragment) &amp;#123;    if (DEBUG) Log.v(TAG, &quot;remove: &quot; + fragment + &quot; nesting&#x3D;&quot; + fragment.mBackStackNesting);    final boolean inac"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-10-18T13:27:09.000Z"><meta property="article:modified_time" content="2022-07-23T10:38:56.390Z"><meta property="article:author" content="文理兼修电脑首席"><meta property="article:tag" content="Android"><meta name="twitter:card" content="summary"><link rel="alternate" href="/limxtop/atom.xml" title="若批评不自由，则赞美无意义" type="application/atom+xml"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/limxtop/css/style.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/limxtop/" id="logo">若批评不自由，则赞美无意义</a></h1></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/limxtop/">Home</a> <a class="main-nav-link" href="/limxtop/archives">Archives</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/limxtop/atom.xml" title="RSS Feed"></a> <a id="nav-search-btn" class="nav-icon" title="Search"></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://limxtop1989.github.io/limxtop"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-FragmentManager源码剖析2" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" class="article-date"><time datetime="2021-10-18T13:27:09.000Z" itemprop="datePublished">2021-10-18</time></a></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">FragmentManager源码剖析二</h1></header><div class="article-entry" itemprop="articleBody"><h1 id="remove-detach-fragment差别"><a class="anchor" href="#remove-detach-fragment差别">#</a> remove &amp; detach Fragment 差别</h1><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeFragment</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"remove: "</span> <span class="token operator">+</span> fragment <span class="token operator">+</span> <span class="token string">" nesting="</span> <span class="token operator">+</span> fragment<span class="token punctuation">.</span>mBackStackNesting<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> inactive <span class="token operator">=</span> <span class="token operator">!</span>fragment<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached <span class="token operator">||</span> inactive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            mAdded<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        fragment<span class="token punctuation">.</span>mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        fragment<span class="token punctuation">.</span>mRemoving <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">detachFragment</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"detach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        fragment<span class="token punctuation">.</span>mDetached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token comment">// We are not already in back stack, so need to remove the fragment.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"remove from detach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                mAdded<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            fragment<span class="token punctuation">.</span>mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>都是移出 mAdded 集合，并将 mAdded 置为 false，区别在更新的标记不同 mRemoving &amp; mDetached。在 FragmentManager 同步状态调用时，有对 remove &amp; detach 的状态同步。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Changes the state of the fragment manager to &#123;@code newState&#125;. If the fragment manager</pre></td></tr><tr><td data-num="3"></td><td><pre> * changes state or &#123;@code always&#125; is &#123;@code true&#125;, any fragments within it have their</pre></td></tr><tr><td data-num="4"></td><td><pre> * states updated as well.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param newState The new state for the fragment manager</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param always If &#123;@code true&#125;, all fragments update their state, even</pre></td></tr><tr><td data-num="8"></td><td><pre> *               if &#123;@code newState&#125; matches the current fragment manager's state.</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveToState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">,</span> <span class="token keyword">boolean</span> always<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHost <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newState <span class="token operator">!=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>INITIALIZING<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>always <span class="token operator">&amp;&amp;</span> newState <span class="token operator">==</span> mCurState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    mCurState <span class="token operator">=</span> newState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mActive <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token comment">// Fragment add &amp; attach 后的状态同步</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">int</span> numAdded <span class="token operator">=</span> mAdded<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numAdded<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token class-name">Fragment</span> f <span class="token operator">=</span> mAdded<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// and detached.</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">int</span> numActive <span class="token operator">=</span> mActive<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numActive<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token class-name">Fragment</span> f <span class="token operator">=</span> mActive<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>						<span class="token comment">// Fragment 激活后执行 remove 或者 detach，同步状态。</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>mRemoving <span class="token operator">||</span> f<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>f<span class="token punctuation">.</span>mIsNewlyAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token function">startPendingDeferredFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mNeedMenuInvalidate <span class="token operator">&amp;&amp;</span> mHost <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mCurState <span class="token operator">==</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>RESUMED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            mHost<span class="token punctuation">.</span><span class="token function">onSupportInvalidateOptionsMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Moves a fragment to its expected final state or the fragment manager's state, depending</pre></td></tr><tr><td data-num="3"></td><td><pre> * on whether the fragment manager's state is raised properly.</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param f The fragment to change.</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mActive<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>mWho<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Ignoring moving "</span> <span class="token operator">+</span> f <span class="token operator">+</span> <span class="token string">" to state "</span> <span class="token operator">+</span> mCurState</pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token operator">+</span> <span class="token string">"since it is not added to "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">int</span> nextState <span class="token operator">=</span> mCurState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>mRemoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            nextState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            nextState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>INITIALIZING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">moveToState</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> nextState<span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">getNextTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">getNextTransitionStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>对于 Remove 如果 nextState 是 CREATED，Fragment 只会 <code>f.performDestroyView()</code> ，但如果是 INITIALIZING，分两种情况：</p><ol><li>不在回退栈，执行 <code>f.performDestroy()</code> ;</li><li>在回退栈，执行 <code>f.performDetach()</code> ; 并 <code>makeInactive(f);</code></li></ol><p>对于 detach，nextState 是 CREATED，也即只执行 <code>f.performDestroyView()</code></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"ReferenceEquality"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveToState</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> f<span class="token punctuation">,</span> <span class="token keyword">int</span> newState<span class="token punctuation">,</span> <span class="token keyword">int</span> transit<span class="token punctuation">,</span> <span class="token keyword">int</span> transitionStyle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">boolean</span> keepActive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Fragments that are not currently added will sit in the onCreate() state.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">.</span>mAdded <span class="token operator">||</span> f<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> newState <span class="token operator">></span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        newState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>CREATED<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="add-attach-fragment区别"><a class="anchor" href="#add-attach-fragment区别">#</a> add &amp; attach Fragment 区别</h1><p>由于 addFragment 有 activate 调用，fragment 已经在 mActive 映射里，允许状态同步，但 attach 没有 activate 调用，于是状态不同步。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Moves a fragment to its expected final state or the fragment manager's state, depending</pre></td></tr><tr><td data-num="3"></td><td><pre> * on whether the fragment manager's state is raised properly.</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param f The fragment to change.</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mActive<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>mWho<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Ignoring moving "</span> <span class="token operator">+</span> f <span class="token operator">+</span> <span class="token string">" to state "</span> <span class="token operator">+</span> mCurState</pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token operator">+</span> <span class="token string">"since it is not added to "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">int</span> nextState <span class="token operator">=</span> mCurState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>mRemoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            nextState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            nextState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>INITIALIZING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">moveToState</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> nextState<span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">getNextTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">getNextTransitionStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFragment</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> fragment<span class="token punctuation">,</span> <span class="token keyword">boolean</span> moveToStateNow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"add: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token operator">*</span><span class="token operator">*</span><span class="token function">makeActive</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这是主要区别 **</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Fragment already added: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            mAdded<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        fragment<span class="token punctuation">.</span>mAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        fragment<span class="token punctuation">.</span>mRemoving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            fragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>moveToStateNow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token function">moveToState</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">attachFragment</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"attach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        fragment<span class="token punctuation">.</span>mDetached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Fragment already added: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"add from attach: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                mAdded<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            fragment<span class="token punctuation">.</span>mAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="show和hide-fragment区别"><a class="anchor" href="#show和hide-fragment区别">#</a> Show 和 hide Fragment 区别</h1><p>首先，更新 mHidden 标记。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Marks a fragment as hidden to be later animated in with</pre></td></tr><tr><td data-num="3"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hideFragment</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"hide: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        fragment<span class="token punctuation">.</span>mHidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        fragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token operator">!</span>fragment<span class="token punctuation">.</span>mHiddenChanged<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre> * Marks a fragment as shown to be later animated in with</pre></td></tr><tr><td data-num="19"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num="20"></td><td><pre> *</pre></td></tr><tr><td data-num="21"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num="22"></td><td><pre> */</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">showFragment</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"show: "</span> <span class="token operator">+</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        fragment<span class="token punctuation">.</span>mHidden <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        fragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token operator">!</span>fragment<span class="token punctuation">.</span>mHiddenChanged<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>故事并没有就此结束，看下这个标记如何使用。</p><p>首先，hidden 后，Fragment 下的 View 为 Gone，不贡献视图。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentStateManager</span>#moveToExpectedState</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span>USE_STATE_MANAGER <span class="token operator">&amp;&amp;</span> mFragment<span class="token punctuation">.</span>mHiddenChanged<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mView <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mFragment<span class="token punctuation">.</span>mContainer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// Get the controller and enqueue the show/hide</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">SpecialEffectsController</span> controller <span class="token operator">=</span> <span class="token class-name">SpecialEffectsController</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">getOrCreateController</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mContainer<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                        mFragment<span class="token punctuation">.</span><span class="token function">getParentFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            controller<span class="token punctuation">.</span><span class="token function">enqueueHide</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            controller<span class="token punctuation">.</span><span class="token function">enqueueShow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mFragmentManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        mFragment<span class="token punctuation">.</span>mFragmentManager<span class="token punctuation">.</span><span class="token function">invalidateMenuForFragment</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    mFragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    mFragment<span class="token punctuation">.</span><span class="token function">onHiddenChanged</span><span class="token punctuation">(</span>mFragment<span class="token punctuation">.</span>mHidden<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其次，hidden 后，Fragment 不再贡献菜单项</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#dispatchPrepareOptionsMenu</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">boolean</span> <span class="token function">dispatchPrepareOptionsMenu</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Menu</span> menu<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurState <span class="token operator">&lt;</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">boolean</span> show <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Fragment</span> f <span class="token operator">:</span> mFragmentStore<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isParentMenuVisible</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span><span class="token function">performPrepareOptionsMenu</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                show <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> show<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>Fragment</span>#performPrepareOptionsMenu</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">boolean</span> <span class="token function">performPrepareOptionsMenu</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Menu</span> menu<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">boolean</span> show <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHasMenu <span class="token operator">&amp;&amp;</span> mMenuVisible<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            show <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token function">onPrepareOptionsMenu</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        show <span class="token operator">|=</span> mChildFragmentManager<span class="token punctuation">.</span><span class="token function">dispatchPrepareOptionsMenu</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> show<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>显隐切换完成后，androidx.fragment.app.Fragment#onHiddenChanged 会得到通知调用。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#completeShowHideFragment</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentStateManager</span>#moveToExpectedState</pre></td></tr></table></figure><h1 id="fragmentmanager-派发生命周期方法"><a class="anchor" href="#fragmentmanager-派发生命周期方法">#</a> FragmentManager 派发生命周期方法</h1><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FragmentActivity</span> <span class="token keyword">extends</span> <span class="token class-name">ComponentActivity</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">final</span> <span class="token class-name">FragmentController</span> mFragments <span class="token operator">=</span> <span class="token class-name">FragmentController</span><span class="token punctuation">.</span><span class="token function">createController</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>					<span class="token keyword">new</span> <span class="token class-name">HostCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>mFragments 负责 Activity 生命周期方法，派发给 FragmentManager，再遍历逐个派发给旗下的 Fragment。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Perform initialization of all fragments.</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    mFragments<span class="token punctuation">.</span><span class="token function">attachHost</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/*parent*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">Parcelable</span> p <span class="token operator">=</span> savedInstanceState<span class="token punctuation">.</span><span class="token function">getParcelable</span><span class="token punctuation">(</span>FRAGMENTS_TAG<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        mFragments<span class="token punctuation">.</span><span class="token function">restoreSaveState</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    mFragmentLifecycleRegistry<span class="token punctuation">.</span><span class="token function">handleLifecycleEvent</span><span class="token punctuation">(</span><span class="token class-name">Lifecycle<span class="token punctuation">.</span>Event</span><span class="token punctuation">.</span>ON_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    mFragments<span class="token punctuation">.</span><span class="token function">dispatchCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Moves all Fragments managed by the controller's FragmentManager</pre></td></tr><tr><td data-num="3"></td><td><pre> * into the create state.</pre></td></tr><tr><td data-num="4"></td><td><pre> * &lt;p>Call when Fragments should be created.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @see Fragment#onCreate(Bundle)</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    mHost<span class="token punctuation">.</span>mFragmentManager<span class="token punctuation">.</span><span class="token function">dispatchCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>dispatchCreate 终导致 FragmentManagerImpl 的当前状态 <code>mCurState</code> 变更。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#dispatchCreate</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">dispatchCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    mStateSaved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    mStopped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    mNonConfig<span class="token punctuation">.</span><span class="token function">setIsStateSaved</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">dispatchStateChange</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span><span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#dispatchStateChange</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchStateChange</span><span class="token punctuation">(</span><span class="token keyword">int</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        mExecutingActions <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        mFragmentStore<span class="token punctuation">.</span><span class="token function">dispatchStateChange</span><span class="token punctuation">(</span>nextState<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">moveToState</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>USE_STATE_MANAGER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecialEffectsController</span><span class="token punctuation">></span></span> controllers <span class="token operator">=</span> <span class="token function">collectAllSpecialEffectsController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SpecialEffectsController</span> controller <span class="token operator">:</span> controllers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                controller<span class="token punctuation">.</span><span class="token function">forceCompleteAllOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        mExecutingActions <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// 同步生命周期状态给 mActive 内 fragment 集合</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">void</span> <span class="token function">dispatchStateChange</span><span class="token punctuation">(</span><span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">:</span> mActive<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentStateManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            fragmentStateManager<span class="token punctuation">.</span><span class="token function">setFragmentManagerState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#<span class="token function">moveToState</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * Changes the state of the fragment manager to &#123;@code newState&#125;. If the fragment manager</pre></td></tr><tr><td data-num="4"></td><td><pre> * changes state or &#123;@code always&#125; is &#123;@code true&#125;, any fragments within it have their</pre></td></tr><tr><td data-num="5"></td><td><pre> * states updated as well.</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param newState The new state for the fragment manager</pre></td></tr><tr><td data-num="8"></td><td><pre> * @param always If &#123;@code true&#125;, all fragments update their state, even</pre></td></tr><tr><td data-num="9"></td><td><pre> *               if &#123;@code newState&#125; matches the current fragment manager's state.</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveToState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">,</span> <span class="token keyword">boolean</span> always<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHost <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newState <span class="token operator">!=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>INITIALIZING<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>always <span class="token operator">&amp;&amp;</span> newState <span class="token operator">==</span> mCurState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    mCurState <span class="token operator">=</span> newState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>USE_STATE_MANAGER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        mFragmentStore<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Fragment</span> f <span class="token operator">:</span> mFragmentStore<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// and detached.</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                mFragmentStore<span class="token punctuation">.</span><span class="token function">getActiveFragmentStateManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token class-name">Fragment</span> f <span class="token operator">=</span> fragmentStateManager<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">.</span>mIsNewlyAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">boolean</span> beingRemoved <span class="token operator">=</span> f<span class="token punctuation">.</span>mRemoving <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>beingRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                mFragmentStore<span class="token punctuation">.</span><span class="token function">makeInactive</span><span class="token punctuation">(</span>fragmentStateManager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">startPendingDeferredFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mNeedMenuInvalidate <span class="token operator">&amp;&amp;</span> mHost <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mCurState <span class="token operator">==</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span>RESUMED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        mHost<span class="token punctuation">.</span><span class="token function">onSupportInvalidateOptionsMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#moveFragmentToExpectedState</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Fragment</span> f <span class="token operator">:</span> mAdded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">=</span> mActive<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>mWho<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentStateManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            fragmentStateManager<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// and detached.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">:</span> mActive<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragmentStateManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            fragmentStateManager<span class="token punctuation">.</span><span class="token function">moveToExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">Fragment</span> f <span class="token operator">=</span> fragmentStateManager<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">boolean</span> beingRemoved <span class="token operator">=</span> f<span class="token punctuation">.</span>mRemoving <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">isInBackStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>beingRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token function">makeInactive</span><span class="token punctuation">(</span>fragmentStateManager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>注意只有在 mActive 集合的 Fragment 才可以 <code>moveToExpectedState</code> ，attach 阶段的 Fragment 并未进入此集合，add 之后才进入，此后 Fragment 接收生命周期方法派发。</p><h1 id="backstack"><a class="anchor" href="#backstack">#</a> BackStack</h1><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Implementation of &#123;@link FragmentManagerImpl.OpGenerator&#125;.</pre></td></tr><tr><td data-num="3"></td><td><pre> * This operation is added to the list of pending actions during &#123;@link #commit()&#125;, and</pre></td></tr><tr><td data-num="4"></td><td><pre> * will be executed on the UI thread to run this FragmentTransaction.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param records Modified to add this BackStackRecord</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param isRecordPop Modified to add a false (this isn't a pop)</pre></td></tr><tr><td data-num="8"></td><td><pre> * @return true always because the records and isRecordPop will always be changed</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">generateOps</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isRecordPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FragmentManagerImpl</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Run: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    records<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    isRecordPop<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAddToBackStack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        mManager<span class="token punctuation">.</span><span class="token function">addBackStackState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">addBackStackState</span><span class="token punctuation">(</span><span class="token class-name">BackStackRecord</span> state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBackStack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        mBackStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    mBackStack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>把当前 backStackRecord 即事务加入 mBackStack 集合。此处可以猜想：当接收 back 事件时，activity 先派发 back 事件给 FragmentManager，如果 mBackStack 存在元素，则将列表末尾的事务 revert，并移出集合，指针向左偏移一位，并直接返回。如果 FragmentManager 不回应 back event，那么由 Activity 继续回应。我们看下具体实现是否这样。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>activity<span class="token punctuation">.</span></span>ComponentActivity</span>#onBackPressed</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * Called when the activity has detected the user's press of the back</pre></td></tr><tr><td data-num="4"></td><td><pre> * key. The &#123;@link #getOnBackPressedDispatcher() OnBackPressedDispatcher&#125; will be given a</pre></td></tr><tr><td data-num="5"></td><td><pre> * chance to handle the back button before the default behavior of</pre></td></tr><tr><td data-num="6"></td><td><pre> * &#123;@link android.app.Activity#onBackPressed()&#125; is invoked.</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * @see #getOnBackPressedDispatcher()</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token annotation punctuation">@MainThread</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    mOnBackPressedDispatcher<span class="token punctuation">.</span><span class="token function">onBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OnBackPressedDispatcher</span> mOnBackPressedDispatcher <span class="token operator">=</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">new</span> <span class="token class-name">OnBackPressedDispatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>              <span class="token class-name">ComponentActivity</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>activity<span class="token punctuation">.</span></span>OnBackPressedDispatcher</span>#onBackPressed</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre> * Trigger a call to the currently added &#123;@link OnBackPressedCallback callbacks&#125; in reverse</pre></td></tr><tr><td data-num="27"></td><td><pre> * order in which they were added. Only if the most recently added callback is not</pre></td></tr><tr><td data-num="28"></td><td><pre> * &#123;@link OnBackPressedCallback#isEnabled() enabled&#125;</pre></td></tr><tr><td data-num="29"></td><td><pre> * will any previously added callback be called.</pre></td></tr><tr><td data-num="30"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="31"></td><td><pre> * It is strongly recommended to call &#123;@link #hasEnabledCallbacks()&#125; prior to calling</pre></td></tr><tr><td data-num="32"></td><td><pre> * this method to determine if there are any enabled callbacks that will be triggered</pre></td></tr><tr><td data-num="33"></td><td><pre> * by this method as calling this method.</pre></td></tr><tr><td data-num="34"></td><td><pre> */</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token annotation punctuation">@MainThread</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OnBackPressedCallback</span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            mOnBackPressedCallbacks<span class="token punctuation">.</span><span class="token function">descendingIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">OnBackPressedCallback</span> callback <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>						<span class="token comment">// 如果回调回应 back 事件，则返回</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            callback<span class="token punctuation">.</span><span class="token function">handleOnBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>		<span class="token comment">// FragmentManager 没回应，则继续走这里</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFallbackOnBackPressed <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>				<span class="token comment">// 为 OnBackPressedDispatcher 初始化时，传入的回调方法，其实现是</span></pre></td></tr><tr><td data-num="50"></td><td><pre>				<span class="token comment">// 调用 Activity 的 onBackPressed ()</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        mFallbackOnBackPressed<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>FragmentManager 如何注册 callback</p><p>→androidx.fragment.app.FragmentActivity#init</p><p>→androidx.fragment.app.FragmentController#attachHost</p><p>→androidx.fragment.app.FragmentManager#attachController</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"SyntheticAccessor"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">attachController</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FragmentHostCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> host<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FragmentContainer</span> container<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Fragment</span> parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHost <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Already attached"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    mHost <span class="token operator">=</span> host<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    mContainer <span class="token operator">=</span> container<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    mParent <span class="token operator">=</span> parent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// Add a FragmentOnAttachListener to the parent fragment / host to support</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// backward compatibility with the deprecated onAttachFragment() APIs</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function">addFragmentOnAttachListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FragmentOnAttachListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAttachFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FragmentManager</span> fragmentManager<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                parent<span class="token punctuation">.</span><span class="token function">onAttachFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token keyword">instanceof</span> <span class="token class-name">FragmentOnAttachListener</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">addFragmentOnAttachListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FragmentOnAttachListener</span><span class="token punctuation">)</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// Since the callback depends on us being the primary navigation fragment,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// update our callback now that we have a parent so that we have the correct</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// state by default</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token function">updateOnBackPressedCallbackEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// Set up the OnBackPressedCallback</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token keyword">instanceof</span> <span class="token class-name">OnBackPressedDispatcherOwner</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">OnBackPressedDispatcherOwner</span> dispatcherOwner <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OnBackPressedDispatcherOwner</span><span class="token punctuation">)</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        mOnBackPressedDispatcher <span class="token operator">=</span> dispatcherOwner<span class="token punctuation">.</span><span class="token function">getOnBackPressedDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token class-name">LifecycleOwner</span> owner <span class="token operator">=</span> parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> parent <span class="token operator">:</span> dispatcherOwner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        mOnBackPressedDispatcher<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> mOnBackPressedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		<span class="token comment">// 代码省略</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OnBackPressedCallback</span> mOnBackPressedCallback <span class="token operator">=</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">new</span> <span class="token class-name">OnBackPressedCallback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleOnBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleOnBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#handleOnBackPressed</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"WeakerAccess"</span><span class="token punctuation">)</span> <span class="token comment">/* synthetic access */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">handleOnBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// First, execute any pending actions to make sure we're in an</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// up to date view of the world just in case anyone is queuing</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// up transactions that change the back stack then immediately</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// calling onBackPressed()</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mOnBackPressedCallback<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// We still have a back stack, so we can pop</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">popBackStackImmediate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// Sigh. Due to FragmentManager's asynchronicity, we can</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// get into cases where we *think* we can handle the back</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// button but because of frame perfect dispatch, we fell</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// on our face. Since our callback is disabled, we can</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// re-trigger the onBackPressed() to dispatch to the next</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// enabled callback</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        mOnBackPressedDispatcher<span class="token punctuation">.</span><span class="token function">onBackPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>看 fragmentManager.popBackStackImmediate ()</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">popBackStackImmediate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">checkStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">popBackStackImmediate</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Used by all public popBackStackImmediate methods, this executes pending transactions and</pre></td></tr><tr><td data-num="3"></td><td><pre> * returns true if the pop action did anything, regardless of what other pending</pre></td></tr><tr><td data-num="4"></td><td><pre> * transactions did.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @return true if the pop operation did anything or false otherwise.</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">popBackStackImmediate</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">ensureExecReady</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPrimaryNav <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token comment">// We have a primary nav fragment</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token operator">&amp;&amp;</span> id <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token comment">// No valid id (since they're local)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token operator">&amp;&amp;</span> name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// no name to pop to (since they're local)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">FragmentManager</span> childManager <span class="token operator">=</span> mPrimaryNav<span class="token punctuation">.</span><span class="token function">getChildFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>childManager<span class="token punctuation">.</span><span class="token function">popBackStackImmediate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token comment">// We did something, just not to this specific FragmentManager. Return true.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">boolean</span> executePop <span class="token operator">=</span> <span class="token function">popBackStackState</span><span class="token punctuation">(</span>mTmpRecords<span class="token punctuation">,</span> mTmpIsPop<span class="token punctuation">,</span> name<span class="token punctuation">,</span> id<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>executePop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        mExecutingActions <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token function">removeRedundantOperationsAndExecute</span><span class="token punctuation">(</span>mTmpRecords<span class="token punctuation">,</span> mTmpIsPop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token function">cleanupExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">updateOnBackPressedCallbackEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">doPendingDeferredStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token function">burpActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> executePop<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>popBackStackState 获取回退事务集合，交由 removeRedundantOperationsAndExecute 执行事务回退。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">boolean</span> <span class="token function">popBackStackState</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isRecordPop<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                              <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBackStack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token comment">// 无参数回退，只回退一个事务</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> id <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> POP_BACK_STACK_INCLUSIVE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">int</span> last <span class="token operator">=</span> mBackStack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        records<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mBackStack<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        isRecordPop<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				<span class="token comment">// 指定 id 或者 backStack name 回退，可以一次回退多个事务。</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> id <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// If a name or ID is specified, look for that place in</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">// the stack.</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            index <span class="token operator">=</span> mBackStack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token class-name">BackStackRecord</span> bss <span class="token operator">=</span> mBackStack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>bss<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> id <span class="token operator">==</span> bss<span class="token punctuation">.</span>mIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                index<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>POP_BACK_STACK_INCLUSIVE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                index<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token comment">// Consume all following entries that match.</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token class-name">BackStackRecord</span> bss <span class="token operator">=</span> mBackStack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>bss<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                            <span class="token operator">||</span> <span class="token punctuation">(</span>id <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> id <span class="token operator">==</span> bss<span class="token punctuation">.</span>mIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        index<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> mBackStack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mBackStack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">></span> index<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            records<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mBackStack<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            isRecordPop<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>事务从 mBackStack 回退栈管理集合移出，并加入 records 用于执行事务，对应的 isRecordPop 元素设置为 true，标记位回退事务，最后执行逆向操作，实现回退。</p><p>→androidx.fragment.app.FragmentManagerImpl#removeRedundantOperationsAndExecute</p><p>→androidx.fragment.app.FragmentManagerImpl#executeOpsTogether</p><p>→androidx.fragment.app.FragmentManager#executeOps</p><p>→androidx.fragment.app.BackStackRecord#executePopOps</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#executeOps</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * Run the operations in the BackStackRecords, either to push or pop.</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param records The list of records whose operations should be run.</pre></td></tr><tr><td data-num="6"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param startIndex The index of the first entry in records to run.</pre></td></tr><tr><td data-num="8"></td><td><pre> * @param endIndex One past the index of the final entry in records to run.</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">executeOps</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackStackRecord</span><span class="token punctuation">></span></span> records<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isRecordPop<span class="token punctuation">,</span> <span class="token keyword">int</span> startIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">BackStackRecord</span> <span class="token keyword">record</span> <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPop <span class="token operator">=</span> isRecordPop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">bumpBackStackNesting</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token comment">// Only execute the add operations at the end of</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// all transactions.</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">boolean</span> moveToState <span class="token operator">=</span> i <span class="token operator">==</span> <span class="token punctuation">(</span>endIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">executePopOps</span><span class="token punctuation">(</span>moveToState<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">bumpBackStackNesting</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">executeOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>BackStackRecord</span>#executePopOps</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre> * Reverses the execution of the operations within this transaction. The Fragment states will</pre></td></tr><tr><td data-num="31"></td><td><pre> * only be modified if reordering is not allowed.</pre></td></tr><tr><td data-num="32"></td><td><pre> *</pre></td></tr><tr><td data-num="33"></td><td><pre> * @param moveToState &#123;@code true&#125; if added fragments should be moved to their final state</pre></td></tr><tr><td data-num="34"></td><td><pre> *                    in ordered transactions</pre></td></tr><tr><td data-num="35"></td><td><pre> */</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">void</span> <span class="token function">executePopOps</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> moveToState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> opNum <span class="token operator">=</span> mOps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> opNum <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> opNum<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">Op</span> op <span class="token operator">=</span> mOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>opNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token class-name">Fragment</span> f <span class="token operator">=</span> op<span class="token punctuation">.</span>mFragment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setPopDirection</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setAnimations</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>mEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mExitAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopExitAnim<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setNextTransition</span><span class="token punctuation">(</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span><span class="token function">reverseTransit</span><span class="token punctuation">(</span>mTransition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token comment">// Reverse the target and source names for pop operations</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setSharedElementNames</span><span class="token punctuation">(</span>mSharedElementTargetNames<span class="token punctuation">,</span> mSharedElementSourceNames<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>mCmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token keyword">case</span> OP_ADD<span class="token operator">:</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setExitAnimationOrder</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">removeFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token keyword">case</span> OP_REMOVE<span class="token operator">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">addFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token keyword">case</span> OP_HIDE<span class="token operator">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">showFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token keyword">case</span> OP_SHOW<span class="token operator">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setExitAnimationOrder</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">hideFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">case</span> OP_DETACH<span class="token operator">:</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">attachFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">case</span> OP_ATTACH<span class="token operator">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setExitAnimationOrder</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">detachFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token keyword">case</span> OP_SET_PRIMARY_NAV<span class="token operator">:</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setPrimaryNavigationFragment</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token keyword">case</span> OP_UNSET_PRIMARY_NAV<span class="token operator">:</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setPrimaryNavigationFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token keyword">case</span> OP_SET_MAX_LIFECYCLE<span class="token operator">:</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">setMaxLifecycle</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mOldMaxState<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unknown cmd: "</span> <span class="token operator">+</span> op<span class="token punctuation">.</span>mCmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mReorderingAllowed <span class="token operator">&amp;&amp;</span> op<span class="token punctuation">.</span>mCmd <span class="token operator">!=</span> OP_REMOVE <span class="token operator">&amp;&amp;</span> f <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span>USE_STATE_MANAGER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                mManager<span class="token punctuation">.</span><span class="token function">moveFragmentToExpectedState</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mReorderingAllowed <span class="token operator">&amp;&amp;</span> moveToState <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">FragmentManager</span><span class="token punctuation">.</span>USE_STATE_MANAGER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        mManager<span class="token punctuation">.</span><span class="token function">moveToState</span><span class="token punctuation">(</span>mManager<span class="token punctuation">.</span>mCurState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="backpressedcallback注册和反注册"><a class="anchor" href="#backpressedcallback注册和反注册">#</a> BackPressedCallback 注册和反注册</h1><p>注册和反注册有些值得揣摩，它和以往的模式略有不同。一般而言，注册和反注册都是提供一对 API，add &amp; remove 或者 register &amp; unregister。但这里 mOnBackPressedDispatcher 只提供 addCallback，反注册是 mOnBackPressedCallback 自己调用 cancel 方法实现。</p><h2 id="注册"><a class="anchor" href="#注册">#</a> 注册</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>FragmentManager</span>#attachController</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"SyntheticAccessor"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">attachController</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FragmentHostCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> host<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FragmentContainer</span> container<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Fragment</span> parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHost <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Already attached"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    mHost <span class="token operator">=</span> host<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    mContainer <span class="token operator">=</span> container<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    mParent <span class="token operator">=</span> parent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// Set up the OnBackPressedCallback</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token keyword">instanceof</span> <span class="token class-name">OnBackPressedDispatcherOwner</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">OnBackPressedDispatcherOwner</span> dispatcherOwner <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OnBackPressedDispatcherOwner</span><span class="token punctuation">)</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        mOnBackPressedDispatcher <span class="token operator">=</span> dispatcherOwner<span class="token punctuation">.</span><span class="token function">getOnBackPressedDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">LifecycleOwner</span> owner <span class="token operator">=</span> parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> parent <span class="token operator">:</span> dispatcherOwner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				<span class="token comment">// 注册</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        mOnBackPressedDispatcher<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> mOnBackPressedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="反注册"><a class="anchor" href="#反注册">#</a> 反注册</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">dispatchDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    mDestroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">endAnimatingAwayFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">dispatchStateChange</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span><span class="token punctuation">.</span>INITIALIZING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    mHost <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    mContainer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    mParent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mOnBackPressedDispatcher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// mOnBackPressedDispatcher can hold a reference to the host</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// so we need to null it out to prevent memory leaks</span></pre></td></tr><tr><td data-num="12"></td><td><pre>				<span class="token comment">// 反注册</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        mOnBackPressedCallback<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        mOnBackPressedDispatcher <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>注册实现</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>activity<span class="token punctuation">.</span></span>OnBackPressedDispatcher</span>#<span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span></span>LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>activity<span class="token punctuation">.</span></span>OnBackPressedCallback</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * Receive callbacks to a new &#123;@link OnBackPressedCallback&#125; when the given</pre></td></tr><tr><td data-num="4"></td><td><pre> * &#123;@link LifecycleOwner&#125; is at least &#123;@link Lifecycle.State#STARTED started&#125;.</pre></td></tr><tr><td data-num="5"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="6"></td><td><pre> * This will automatically call &#123;@link #addCallback(OnBackPressedCallback)&#125; and</pre></td></tr><tr><td data-num="7"></td><td><pre> * remove the callback as the lifecycle state changes.</pre></td></tr><tr><td data-num="8"></td><td><pre> * As a corollary, if your lifecycle is already at least</pre></td></tr><tr><td data-num="9"></td><td><pre> * &#123;@link Lifecycle.State#STARTED started&#125;, calling this method will result in an immediate</pre></td></tr><tr><td data-num="10"></td><td><pre> * call to &#123;@link #addCallback(OnBackPressedCallback)&#125;.</pre></td></tr><tr><td data-num="11"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="12"></td><td><pre> * When the &#123;@link LifecycleOwner&#125; is &#123;@link Lifecycle.State#DESTROYED destroyed&#125;, it will</pre></td></tr><tr><td data-num="13"></td><td><pre> * automatically be removed from the list of callbacks. The only time you would need to</pre></td></tr><tr><td data-num="14"></td><td><pre> * manually call &#123;@link OnBackPressedCallback#remove()&#125; is if</pre></td></tr><tr><td data-num="15"></td><td><pre> * you'd like to remove the callback prior to destruction of the associated lifecycle.</pre></td></tr><tr><td data-num="16"></td><td><pre> *</pre></td></tr><tr><td data-num="17"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="18"></td><td><pre> * If the Lifecycle is already &#123;@link Lifecycle.State#DESTROYED destroyed&#125;</pre></td></tr><tr><td data-num="19"></td><td><pre> * when this method is called, the callback will not be added.</pre></td></tr><tr><td data-num="20"></td><td><pre> *</pre></td></tr><tr><td data-num="21"></td><td><pre> * @param owner The LifecycleOwner which controls when the callback should be invoked</pre></td></tr><tr><td data-num="22"></td><td><pre> * @param onBackPressedCallback The callback to add</pre></td></tr><tr><td data-num="23"></td><td><pre> *</pre></td></tr><tr><td data-num="24"></td><td><pre> * @see #onBackPressed()</pre></td></tr><tr><td data-num="25"></td><td><pre> */</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"LambdaLast"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token annotation punctuation">@MainThread</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">LifecycleOwner</span> owner<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">OnBackPressedCallback</span> onBackPressedCallback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">Lifecycle</span> lifecycle <span class="token operator">=</span> owner<span class="token punctuation">.</span><span class="token function">getLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lifecycle<span class="token punctuation">.</span><span class="token function">getCurrentState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Lifecycle<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>DESTROYED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token comment">// 注册 action2</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    onBackPressedCallback<span class="token punctuation">.</span><span class="token function">addCancellable</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">LifecycleOnBackPressedCancellable</span><span class="token punctuation">(</span>lifecycle<span class="token punctuation">,</span> onBackPressedCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>onBackPressedCallback 的注册委托给 LifecycleOnBackPressedCancellable，同时，持有 LifecycleOnBackPressedCancellable 的实例引用，但反注册时，onBackPressedCallback 调用 cancel 方法，通知 LifecycleOnBackPressedCancellable 实例反注册。也就是 A 向 C 注册，其实是委托给 B 实现注册，反注册通过 A 持有 B 的引用，也由 B 负责完成。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LifecycleOnBackPressedCancellable</span> <span class="token keyword">implements</span> <span class="token class-name">LifecycleEventObserver</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token class-name">Cancellable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lifecycle</span> mLifecycle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OnBackPressedCallback</span> mOnBackPressedCallback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Nullable</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Cancellable</span> mCurrentCancellable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">LifecycleOnBackPressedCancellable</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Lifecycle</span> lifecycle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">OnBackPressedCallback</span> onBackPressedCallback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        mLifecycle <span class="token operator">=</span> lifecycle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        mOnBackPressedCallback <span class="token operator">=</span> onBackPressedCallback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>				<span class="token comment">// 注册 action1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        lifecycle<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStateChanged</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">LifecycleOwner</span> source<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Lifecycle<span class="token punctuation">.</span>Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token class-name">Lifecycle<span class="token punctuation">.</span>Event</span><span class="token punctuation">.</span>ON_START<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>						<span class="token comment">// 实际注册</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            mCurrentCancellable <span class="token operator">=</span> <span class="token function">addCancellableCallback</span><span class="token punctuation">(</span>mOnBackPressedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token class-name">Lifecycle<span class="token punctuation">.</span>Event</span><span class="token punctuation">.</span>ON_STOP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// Should always be non-null</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentCancellable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                mCurrentCancellable<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token class-name">Lifecycle<span class="token punctuation">.</span>Event</span><span class="token punctuation">.</span>ON_DESTROY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>				<span class="token comment">// 反注册 action1</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        mLifecycle<span class="token punctuation">.</span><span class="token function">removeObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>				<span class="token comment">// 反注册 action2</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        mOnBackPressedCallback<span class="token punctuation">.</span><span class="token function">removeCancellable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentCancellable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>						<span class="token comment">// 实际反注册</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            mCurrentCancellable<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            mCurrentCancellable <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>activity<span class="token punctuation">.</span></span>OnBackPressedDispatcher</span>#addCancellableCallback</pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="49"></td><td><pre> * Internal implementation of &#123;@link #addCallback(OnBackPressedCallback)&#125; that gives</pre></td></tr><tr><td data-num="50"></td><td><pre> * access to the &#123;@link Cancellable&#125; that specifically removes this callback from</pre></td></tr><tr><td data-num="51"></td><td><pre> * the dispatcher without relying on &#123;@link OnBackPressedCallback#remove()&#125; which</pre></td></tr><tr><td data-num="52"></td><td><pre> * is what external developers should be using.</pre></td></tr><tr><td data-num="53"></td><td><pre> *</pre></td></tr><tr><td data-num="54"></td><td><pre> * @param onBackPressedCallback The callback to add</pre></td></tr><tr><td data-num="55"></td><td><pre> * @return a &#123;@link Cancellable&#125; which can be used to &#123;@link Cancellable#cancel() cancel&#125;</pre></td></tr><tr><td data-num="56"></td><td><pre> * the callback and remove it from the set of OnBackPressedCallbacks.</pre></td></tr><tr><td data-num="57"></td><td><pre> */</pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"WeakerAccess"</span><span class="token punctuation">)</span> <span class="token comment">/* synthetic access */</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token annotation punctuation">@MainThread</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token annotation punctuation">@NonNull</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token class-name">Cancellable</span> <span class="token function">addCancellableCallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">OnBackPressedCallback</span> onBackPressedCallback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">//start 后，实际注册进 callback 列表</span></pre></td></tr><tr><td data-num="63"></td><td><pre>		mOnBackPressedCallbacks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>onBackPressedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		<span class="token comment">// 建立 OnBackPressedCancellable 实例 与 onBackPressedCallback 的双向引用并返回</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token class-name">OnBackPressedCancellable</span> cancellable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnBackPressedCancellable</span><span class="token punctuation">(</span>onBackPressedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    onBackPressedCallback<span class="token punctuation">.</span><span class="token function">addCancellable</span><span class="token punctuation">(</span>cancellable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">return</span> cancellable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OnBackPressedCancellable</span> <span class="token keyword">implements</span> <span class="token class-name">Cancellable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OnBackPressedCallback</span> mOnBackPressedCallback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token class-name">OnBackPressedCancellable</span><span class="token punctuation">(</span><span class="token class-name">OnBackPressedCallback</span> onBackPressedCallback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        mOnBackPressedCallback <span class="token operator">=</span> onBackPressedCallback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>				<span class="token comment">//stop 后，实际反注册</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        mOnBackPressedCallbacks<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mOnBackPressedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>				<span class="token comment">// 断开引用</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        mOnBackPressedCallback<span class="token punctuation">.</span><span class="token function">removeCancellable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div><footer class="article-footer"><a data-url="https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" data-id="cl5y4aylx00083q13etws287q" class="article-share-link">Share</a></footer></div><nav id="article-nav"><a href="/limxtop/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">LifeCycle &amp; LiveData源码剖析</div></a><a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">FragmentManager源码剖析一</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/Android-view-coordinate-canvas-coordinate-%E5%9D%90%E6%A0%87%E7%B3%BB/" rel="tag">Android, view coordinate, canvas coordinate, 坐标系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/LifeCycle-LiveData/" rel="tag">LifeCycle, LiveData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-Android-ViewModel/" rel="tag">ViewModel源码剖析, Android, ViewModel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/%E8%8B%B1%E8%AF%AD-%E8%87%AA%E5%AD%A6-%E5%85%A5%E9%97%A8-%E6%8C%87%E5%8D%97-%E6%96%B9%E6%B3%95%E8%AE%BA-%E8%AF%8D%E5%85%B8/" rel="tag">英语,自学,入门,指南,方法论,词典</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/limxtop/tags/Android-view-coordinate-canvas-coordinate-%E5%9D%90%E6%A0%87%E7%B3%BB/" style="font-size:10px">Android, view coordinate, canvas coordinate, 坐标系</a> <a href="/limxtop/tags/LifeCycle-LiveData/" style="font-size:10px">LifeCycle, LiveData</a> <a href="/limxtop/tags/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-Android-ViewModel/" style="font-size:10px">ViewModel源码剖析, Android, ViewModel</a> <a href="/limxtop/tags/%E8%8B%B1%E8%AF%AD-%E8%87%AA%E5%AD%A6-%E5%85%A5%E9%97%A8-%E6%8C%87%E5%8D%97-%E6%96%B9%E6%B3%95%E8%AE%BA-%E8%AF%8D%E5%85%B8/" style="font-size:10px">英语,自学,入门,指南,方法论,词典</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/07/">July 2021</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/limxtop/2022/02/24/Android-view-canvas-%E5%9D%90%E6%A0%87%E7%B3%BB/">Android view &amp; canvas 坐标系</a></li><li><a href="/limxtop/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">LifeCycle &amp; LiveData源码剖析</a></li><li><a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/">FragmentManager源码剖析二</a></li><li><a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/">FragmentManager源码剖析一</a></li><li><a href="/limxtop/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">ViewModel源码剖析</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2022 文理兼修电脑首席<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/limxtop/" class="mobile-nav-link">Home</a> <a href="/limxtop/archives" class="mobile-nav-link">Archives</a></nav><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="stylesheet" href="/limxtop/fancybox/jquery.fancybox.css"><script src="/limxtop/fancybox/jquery.fancybox.pack.js"></script><script src="/limxtop/js/script.js"></script></div></body></html>